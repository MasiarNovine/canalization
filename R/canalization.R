#' \name{get_indices}
#' \alias{get_indices}
#' \title{Retrieve the pair of indices for linear interpolation.}
#' \usage{get_indices(age, ref, sex)}
#' \description{Retrieve the indices for the interpolation of the
#' LMS parameters}
#' \details{
#' The references for the raw measurements only are given for discrete
#' months values, such that for ages in-between, the L, M and S parameters
#' must be interpolated. For simplicity, the values are linearly interpolated.
#' For this reason, the indices for the lower and upper bound in the
#' proximity of the the values of interest must be found by this function.
#' }
#' \arguments{
#' \item{age}{The age of the child.}
#' \item{ref}{The given reference.}
#' \item{sex}{The sex of the child.}
#' }
#' \value{
#'  The relevant indices for interpolation.
#' }

get_indices <- function(age, ref, sex=c("male", "female")) {
  sex <- match.arg(sex)
  index <- 1

  # Get the relevant subset for the given sex
  sex_ids <- which(ref["sex"] == sex)

  for (i in 1:nrow(ref)) {
    # TODO: Fails if age >> ref[i, "age"]
    delta <- age - ref[i, "age"]
    if (delta < 0) {
      # This takes care of the case, if the reference does
      # not contain values for age 0
      # We jump in the next available time period, which is
      # not quite as accurate
      # but we for example lack LMS parameters for the KiGGs data
      if (i == 1 & ref[i, "age"] != 0) {
        index <- i + 1
        break
      } else {
        index <- i
        break
      }
    }
  }

  return(c(index - 1, index))
}

#' \name{get_proportion}
#' \alias{get_proportion}
#' \title{Calculate the proportion factor for precise interpolation.}
#' \usage{get_proportion(age, ref, indices)}
#' \description{
#'  Get the relative proportion, which is necessary for interpolation.
#' }
#' \details{
#' The references for the raw measurements only are given for discrete
#' months values, such that for ages in-between, the L, M and S parameters
#' must be interpolated. For simplicity, the values are linearly interpolated.
#' For this reason, the indices for the lower and upper bound in the proximity
#' of the the values of interest must be found by this function.
#' }
#' \arguments{
#'  \item{age}{The age of the child.}
#'  \item{ref}{The reference as a data.frame.}
#'  \item{indices}{The vector of indices.}
#' }
#' \value{
#'  The proportion of the difference between the lower / upper reference age bound
#'  and the difference of the the age of the child to the upper reference age bound.
#' }
#' \seealso{See also \code{\link{get_indices}}}

get_proportion <- function(age, ref, indices) {
  delta_ref_age <- ref[indices[2], "age"] - ref[indices[1], "age"]
  delta_age_to_ref <- ref[indices[2], "age"] - age

  return(delta_age_to_ref / delta_ref_age)
}

#' \name{interpolate}
#' \alias{interpolate}
#' \title{Linear interpolation between an upper and lower value.}
#' \description{Perform linear interpolation based on the lower / upper
#' reference age bound.}
#' \arguments{
#'  \item{prop}{Proportion of the difference value should be used.}
#'  \item{low}{Lower value based on the lower reference age bound.}
#'  \item{up}{Upper value based on the upper reference age bound.}
#' }
#' \details{
#' The basic functionality to perform linear interpolation using the
#' proportion of the upper and lower age bound,
#' relevant for the respective age of a child.
#' }
#' \value{A 'numeric' value, representing the linear interpolation.}
#' \seealso{See also \code{\link{get_indices}}, \code{\link{get_proportion}},
#' \code{\link{interpolate_to_zscore}}}

interpolate <- function(prop, low, up) {
  return(up - (prop * (up - low)))
}

#' \name{interpolate_to_zscore}
#' \alias{interpolate_to_zscore}
#' \title{Linear interpolation of LMS parameters.}
#' \description{
#'  Interpolation of raw values of either weight, height or BMI to z-scores.
#' }
#' \arguments{
#'  \item{value}{Value to interpolate.}
#'  \item{age}{The age of the child.}
#'  \item{ref}{The reference data.frame.}
#'  \item{type}{The type of the value.}
#' }
#' \details{
#' For getting z-scores for values for ages, not covered by references tables,
#' linear transformation for ages in close proximity are used.
#' }
#' \value{
#' A 'vector' of z-score transforms.
#' }
#' \seealso{See also \code{\link{get_indices}}, \code{\link{get_proportion}}, \code{\link{interpolate}}.}

interpolate_to_zscore <- function(value, age, ref, type=c("weight", "height", "bmi")) {
  type <- match.arg(type)

  indices <- get_indices(age, ref)
  prop <- get_proportion(age, ref, indices)

  interpol_l <- interpolate(prop, ref[indices[1], paste0(type, '_l')], ref[indices[2], paste0(type, '_l')])
  interpol_m <- interpolate(prop, ref[indices[1], paste0(type, '_m')], ref[indices[2], paste0(type, '_m')])
  interpol_s <- interpolate(prop, ref[indices[1], paste0(type, '_s')], ref[indices[2], paste0(type, '_s')])

  return(transform_to_zscore(value, interpol_l, interpol_m, interpol_s))
}

#' \name{transform_to_zscore}
#' \alias{transform_to_zscore}
#' \title{z-score transformation}
#' \usage{transform_to_zscore(y, l, m, s)}
#' \description{
#' Transform raw biometrical measurements to z-scores
#' }
#' \details{
#' Given the LMS parameters and raw measurements for weight, height or BMI,
#' the given values are transformed to z-values, based on the LMS method of
#' Cole (1991), which is commonly applied for growth curve analysis.
#' }
#' \arguments{
#'   \item{y}{Vector of values.}
#'   \item{l}{Exponent parameter of the Box-Cox function.}
#'   \item{m}{The median value.}
#'   \item{s}{The standard coefficient of variance.}
#' }
#' \value{`vector` of transformed values.}
#' \references{
#' Cole, TJ, "The LMS method for constructing normalized growth standards",
#' European journal of clinical nutrition 44, 1 (1990), pp. 45-60.
#' }

transform_to_zscore <- function(y, l, m, s) {
  return(((y / m)^l - 1) / (l * s))
}

#' \name{transform_to_centile}
#' \alias{transform_to_centile}
#' \title{Transformation of z-scores to centiles}
#' \usage{transform_to_centile(z, l, m, s)}
#' \description{
#' Transform z-scores to centiles
#' }
#' \arguments{
#'   \item{z}{Vector of z-scores.}
#'   \item{l}{Exponent parameter of the Box-Cox function.}
#'   \item{m}{The median value.}
#'   \item{s}{The standard coefficient of variance.}
#' }
#' \value{`vector` of transformed values.}
#' \references{
#' Cole, MJ, "The LMS method for constructing normalized growth standards",
#' European journal of clinical nutrition 44, 1 (1990), pp. 45-60.
#' }
#' \seealso{
#' \code{\link{transform_to_zscore}}
#' }

transform_to_centile <- function(z, l, m, s) {
  y <- m * (1 + l * s * z)^(1/l)
  return(y)
}

#' \name{CQV}
#' \alias{CQV}
#' \title{CQV}
#' \usage{CQV(x)}
#' \description{Calculates the CQV of a vector of values.}
#' \arguments{
#'   \item{x}{Vector of values.}
#' }
#' \value{`vector` of transformed values.}

CQV <- function(x) {
	Q3 <- quantile(x, probs=c(0.75));
	Q1 <- quantile(x, probs=c(0.25));
	cqv <- IQR(x) / (Q3 + Q1);
	return(100 * cqv);
}

# TODO: Determine the L and S parameters paced on percentiles for Kromeyer-Hauschild
#' \name{load_reference}
#' \alias{load_reference}
#' \title{Load reference tables.}
#' \description{Using reference tables}
#' \arguments{
#'  \item{ref_name}{Either "WHO", "KiGGS" or "Kromeyer-Hauschild". Default: "WHO".}
#'  \item{na_omit}{Should NAs be omitted? Logical. Default: FALSE.}
#' }
#' \details{
#' The World Health Organization (WHO) provides an international composite reference based on
#' several national references from different countries and continents.
#' `KiGGS` is a reference based on the German nation-wide KiGGS published by the Robert-Koch Institute in Germany.
#' `Kromeyer-Hauschild` is a another German national reference. Note, that currently, for this reference values for
#' weight are used from the `KiGGS` reference.
#' the `KiGGS` reference.
#' }
#' \value{A reference as a `data.table` object.}
#' \references{
#' TJ Cole, "The LMS method for constructing normalized growth standards", European journal of clinical nutrition 44, 1 (1990), pp. 45-60,
#' Stolzenberg, H., H. Kahl, and K. E. Bergmann (May 2007). “Körpermaße bei Kindern und Jugendlichen in Deutschland”. In: Bundesgesundheitsblatt - Gesundheitsforschung - Gesundheitsschutz 50.5, pp. 659–669. issn: 1437-1588. url: https://doi.org/10.1007/s00103-007-0227-5,
#' Kromeyer-Hauschild, K. et al. (Aug. 2001). “Perzentile für den Body-mass-Index für das Kindes- und Jugendalter unter Heranziehung verschiedener deutscher Stichproben”. In: Monatsschrift Kinderheilkunde 149.8, pp. 807–818. issn: 1433-0474. url: https://doi.org/10.1007/s001120170107.
#' }

load_reference <- function(ref_name = c("WHO", "KiGGS", "Kromeyer-Hauschild"),
                           na_omit = FALSE
) {
  ref <- NULL
  age <- sex <- weight_l <- weight_m <- weight_s <- height_l <- height_m <- height_s <- bmi_l <- bmi_m <- bmi_s <- NULL
  if (ref_name == "WHO") {
    ref <- data.table::fread(
      "age sex weight_l weight_m weight_s height_l height_m height_s bmi_l bmi_m bmi_s
      0 male 0.3487 3.3464 0.14602 1 49.8842 0.03795 -0.3053 13.4069 0.0956
      1 male 0.2297 4.4709 0.13395 1 54.7244 0.03557 0.2708 14.9441 0.09027
      2 male 0.197 5.5675 0.12385 1 58.4249 0.03424 0.1118 16.3195 0.08677
      3 male 0.1738 6.3762 0.11727 1 61.4292 0.03328 0.0068 16.8987 0.08495
      4 male 0.1553 7.0023 0.11316 1 63.886 0.03257 -0.0727 17.1579 0.08378
      5 male 0.1395 7.5105 0.1108 1 65.9026 0.03204 -0.137 17.2919 0.08296
      6 male 0.1257 7.934 0.10958 1 67.6236 0.03165 -0.1913 17.3422 0.08234
      7 male 0.1134 8.297 0.10902 1 69.1645 0.03139 -0.2385 17.3288 0.08183
      8 male 0.1021 8.6151 0.10882 1 70.5994 0.03124 -0.2802 17.2647 0.0814
      9 male 0.0917 8.9014 0.10881 1 71.9687 0.03117 -0.3176 17.1662 0.08102
      10 male 0.082 9.1649 0.10891 1 73.2812 0.03118 -0.3516 17.0488 0.08068
      11 male 0.073 9.4122 0.10906 1 74.5388 0.03125 -0.3828 16.9239 0.08037
      12 male 0.0644 9.6479 0.10925 1 75.7488 0.03137 -0.4115 16.7981 0.08009
      13 male 0.0563 9.8749 0.10949 1 76.9186 0.03154 -0.4382 16.6743 0.07982
      14 male 0.0487 10.0953 0.10976 1 78.0497 0.03174 -0.463 16.5548 0.07958
      15 male 0.0413 10.3108 0.11007 1 79.1458 0.03197 -0.4863 16.4409 0.07935
      16 male 0.0343 10.5228 0.11041 1 80.2113 0.03222 -0.5082 16.3335 0.07913
      17 male 0.0275 10.7319 0.11079 1 81.2487 0.0325 -0.5289 16.2329 0.07892
      18 male 0.0211 10.9385 0.11119 1 82.2587 0.03279 -0.5484 16.1392 0.07873
      19 male 0.0148 11.143 0.11164 1 83.2418 0.0331 -0.5669 16.0528 0.07854
      20 male 0.0087 11.3462 0.11211 1 84.1996 0.03342 -0.5846 15.9743 0.07836
      21 male 0.0029 11.5486 0.11261 1 85.1348 0.03376 -0.6014 15.9039 0.07818
      22 male -0.0028 11.7504 0.11314 1 86.0477 0.0341 -0.6174 15.8412 0.07802
      23 male -0.0083 11.9514 0.11369 1 86.941 0.03445 -0.6328 15.7852 0.07786
      24 male -0.0137 12.1515 0.11426 1 87.1161 0.03507 -0.6187 16.0189 0.07785
      25 male -0.0189 12.3502 0.11485 1 87.972 0.03542 -0.584 15.98 0.07792
      26 male -0.024 12.5466 0.11544 1 88.8065 0.03576 -0.5497 15.9414 0.078
      27 male -0.0289 12.7401 0.11604 1 89.6197 0.0361 -0.5166 15.9036 0.07808
      28 male -0.0337 12.9303 0.11664 1 90.412 0.03642 -0.485 15.8667 0.07818
      29 male -0.0385 13.1169 0.11723 1 91.1828 0.03674 -0.4552 15.8306 0.07829
      30 male -0.0431 13.3 0.11781 1 91.9327 0.03704 -0.4274 15.7953 0.07841
      31 male -0.0476 13.4798 0.11839 1 92.6631 0.03733 -0.4016 15.7606 0.07854
      32 male -0.052 13.6567 0.11896 1 93.3753 0.03761 -0.3782 15.7267 0.07867
      33 male -0.0564 13.8309 0.11953 1 94.0711 0.03787 -0.3572 15.6934 0.07882
      34 male -0.0606 14.0031 0.12008 1 94.7532 0.03812 -0.3388 15.661 0.07897
      35 male -0.0648 14.1736 0.12062 1 95.4236 0.03836 -0.3231 15.6294 0.07914
      36 male -0.0689 14.3429 0.12116 1 96.0835 0.03858 -0.3101 15.5988 0.07931
      37 male -0.0729 14.5113 0.12168 1 96.7337 0.03879 -0.3 15.5693 0.0795
      38 male -0.0769 14.6791 0.1222 1 97.3749 0.039 -0.2927 15.541 0.07969
      39 male -0.0808 14.8466 0.12271 1 98.0073 0.03919 -0.2884 15.514 0.0799
      40 male -0.0846 15.014 0.12322 1 98.631 0.03937 -0.2869 15.4885 0.08012
      41 male -0.0883 15.1813 0.12373 1 99.2459 0.03954 -0.2881 15.4645 0.08036
      42 male -0.092 15.3486 0.12425 1 99.8515 0.03971 -0.2919 15.442 0.08061
      43 male -0.0957 15.5158 0.12478 1 100.4485 0.03986 -0.2981 15.421 0.08087
      44 male -0.0993 15.6828 0.12531 1 101.0374 0.04002 -0.3067 15.4013 0.08115
      45 male -0.1028 15.8497 0.12586 1 101.6186 0.04016 -0.3174 15.3827 0.08144
      46 male -0.1063 16.0163 0.12643 1 102.1933 0.04031 -0.3303 15.3652 0.08174
      47 male -0.1097 16.1827 0.127 1 102.7625 0.04045 -0.3452 15.3485 0.08205
      48 male -0.1131 16.3489 0.12759 1 103.3273 0.04059 -0.3622 15.3326 0.08238
      49 male -0.1165 16.515 0.12819 1 103.8886 0.04073 -0.3811 15.3174 0.08272
      50 male -0.1198 16.6811 0.1288 1 104.4473 0.04086 -0.4019 15.3029 0.08307
      51 male -0.123 16.8471 0.12943 1 105.0041 0.041 -0.4245 15.2891 0.08343
      52 male -0.1262 17.0132 0.13005 1 105.5596 0.04113 -0.4488 15.2759 0.0838
      53 male -0.1294 17.1792 0.13069 1 106.1138 0.04126 -0.4747 15.2633 0.08418
      54 male -0.1325 17.3452 0.13133 1 106.6668 0.04139 -0.5019 15.2514 0.08457
      55 male -0.1356 17.5111 0.13197 1 107.2188 0.04152 -0.5303 15.24 0.08496
      56 male -0.1387 17.6768 0.13261 1 107.7697 0.04165 -0.5599 15.2291 0.08536
      57 male -0.1417 17.8422 0.13325 1 108.3198 0.04177 -0.5905 15.2188 0.08577
      58 male -0.1447 18.0073 0.13389 1 108.8689 0.0419 -0.6223 15.2091 0.08617
      59 male -0.1477 18.1722 0.13453 1 109.417 0.04202 -0.6552 15.2 0.08659
      60 male -0.1506 18.3366 0.13517 1 109.9638 0.04214 -0.6892 15.1916 0.087
      61 male -0.2026 18.5057 0.12988 1 110.2647 0.04164 -0.7387 15.2641 0.0839
      62 male -0.213 18.6802 0.13028 1 110.8006 0.04172 -0.7621 15.2616 0.08414
      63 male -0.2234 18.8563 0.13067 1 111.3338 0.0418 -0.7856 15.2604 0.08439
      64 male -0.2338 19.034 0.13105 1 111.8636 0.04187 -0.8089 15.2605 0.08464
      65 male -0.2443 19.2132 0.13142 1 112.3895 0.04195 -0.8322 15.2619 0.0849
      66 male -0.2548 19.394 0.13178 1 112.911 0.04203 -0.8554 15.2645 0.08516
      67 male -0.2653 19.5765 0.13213 1 113.428 0.04211 -0.8785 15.2684 0.08543
      68 male -0.2758 19.7607 0.13246 1 113.941 0.04218 -0.9015 15.2737 0.0857
      69 male -0.2864 19.9468 0.13279 1 114.45 0.04226 -0.9243 15.2801 0.08597
      70 male -0.2969 20.1344 0.13311 1 114.9547 0.04234 -0.9471 15.2877 0.08625
      71 male -0.3075 20.3235 0.13342 1 115.4549 0.04241 -0.9697 15.2965 0.08653
      72 male -0.318 20.5137 0.13372 1 115.9509 0.04249 -0.9921 15.3062 0.08682
      73 male -0.3285 20.7052 0.13402 1 116.4432 0.04257 -1.0144 15.3169 0.08711
      74 male -0.339 20.8979 0.13432 1 116.9325 0.04264 -1.0365 15.3285 0.08741
      75 male -0.3494 21.0918 0.13462 1 117.4196 0.04272 -1.0584 15.3408 0.08771
      76 male -0.3598 21.287 0.13493 1 117.9046 0.0428 -1.0801 15.354 0.08802
      77 male -0.3701 21.4833 0.13523 1 118.388 0.04287 -1.1017 15.3679 0.08833
      78 male -0.3804 21.681 0.13554 1 118.87 0.04295 -1.123 15.3825 0.08865
      79 male -0.3906 21.8799 0.13586 1 119.3508 0.04303 -1.1441 15.3978 0.08898
      80 male -0.4007 22.08 0.13618 1 119.8303 0.04311 -1.1649 15.4137 0.08931
      81 male -0.4107 22.2813 0.13652 1 120.3085 0.04318 -1.1856 15.4302 0.08964
      82 male -0.4207 22.4837 0.13686 1 120.7853 0.04326 -1.206 15.4473 0.08998
      83 male -0.4305 22.6872 0.13722 1 121.2604 0.04334 -1.2261 15.465 0.09033
      84 male -0.4402 22.8915 0.13759 1 121.7338 0.04342 -1.246 15.4832 0.09068
      85 male -0.4499 23.0968 0.13797 1 122.2053 0.0435 -1.2656 15.5019 0.09103
      86 male -0.4594 23.3029 0.13838 1 122.675 0.04358 -1.2849 15.521 0.09139
      87 male -0.4688 23.5101 0.1388 1 123.1429 0.04366 -1.304 15.5407 0.09176
      88 male -0.4781 23.7182 0.13923 1 123.6092 0.04374 -1.3228 15.5608 0.09213
      89 male -0.4873 23.9272 0.13969 1 124.0736 0.04382 -1.3414 15.5814 0.09251
      90 male -0.4964 24.1371 0.14016 1 124.5361 0.0439 -1.3596 15.6023 0.09289
      91 male -0.5053 24.3479 0.14065 1 124.9964 0.04398 -1.3776 15.6237 0.09327
      92 male -0.5142 24.5595 0.14117 1 125.4545 0.04406 -1.3953 15.6455 0.09366
      93 male -0.5229 24.7722 0.1417 1 125.9104 0.04414 -1.4126 15.6677 0.09406
      94 male -0.5315 24.9858 0.14226 1 126.364 0.04422 -1.4297 15.6903 0.09445
      95 male -0.5399 25.2005 0.14284 1 126.8156 0.0443 -1.4464 15.7133 0.09486
      96 male -0.5482 25.4163 0.14344 1 127.2651 0.04438 -1.4629 15.7368 0.09526
      97 male -0.5564 25.6332 0.14407 1 127.7129 0.04446 -1.479 15.7606 0.09567
      98 male -0.5644 25.8513 0.14472 1 128.159 0.04454 -1.4947 15.7848 0.09609
      99 male -0.5722 26.0706 0.14539 1 128.6034 0.04462 -1.5101 15.8094 0.09651
      100 male -0.5799 26.2911 0.14608 1 129.0466 0.0447 -1.5252 15.8344 0.09693
      101 male -0.5873 26.5128 0.14679 1 129.4887 0.04478 -1.5399 15.8597 0.09735
      102 male -0.5946 26.7358 0.14752 1 129.93 0.04487 -1.5542 15.8855 0.09778
      103 male -0.6017 26.9602 0.14828 1 130.3705 0.04495 -1.5681 15.9116 0.09821
      104 male -0.6085 27.1861 0.14905 1 130.8103 0.04503 -1.5817 15.9381 0.09864
      105 male -0.6152 27.4137 0.14984 1 131.2495 0.04511 -1.5948 15.9651 0.09907
      106 male -0.6216 27.6432 0.15066 1 131.6884 0.04519 -1.6076 15.9925 0.09951
      107 male -0.6278 27.875 0.15149 1 132.1269 0.04527 -1.6199 16.0205 0.09994
      108 male -0.6337 28.1092 0.15233 1 132.5652 0.04535 -1.6318 16.049 0.10038
      109 male -0.6393 28.3459 0.15319 1 133.0031 0.04543 -1.6433 16.0781 0.10082
      110 male -0.6446 28.5854 0.15406 1 133.4404 0.04551 -1.6544 16.1078 0.10126
      111 male -0.6496 28.8277 0.15493 1 133.877 0.04559 -1.6651 16.1381 0.1017
      112 male -0.6543 29.0731 0.15581 1 134.313 0.04566 -1.6753 16.1692 0.10214
      113 male -0.6585 29.3217 0.1567 1 134.7483 0.04574 -1.6851 16.2009 0.10259
      114 male -0.6624 29.5736 0.1576 1 135.1829 0.04582 -1.6944 16.2333 0.10303
      115 male -0.6659 29.8289 0.1585 1 135.6168 0.04589 -1.7032 16.2665 0.10347
      116 male -0.6689 30.0877 0.1594 1 136.0501 0.04597 -1.7116 16.3004 0.10391
      117 male -0.6714 30.3501 0.16031 1 136.4829 0.04604 -1.7196 16.3351 0.10435
      118 male -0.6735 30.616 0.16122 1 136.9153 0.04612 -1.7271 16.3704 0.10478
      119 male -0.6752 30.8854 0.16213 1 137.3474 0.04619 -1.7341 16.4065 0.10522
      120 male -0.6764 31.1586 0.16305 1 137.7795 0.04626 -1.7407 16.4433 0.10566
      121 male NA NA NA 1 138.2119 0.04633 -1.7468 16.4807 0.10609
      122 male NA NA NA 1 138.6452 0.0464 -1.7525 16.5189 0.10652
      123 male NA NA NA 1 139.0797 0.04647 -1.7578 16.5578 0.10695
      124 male NA NA NA 1 139.5158 0.04654 -1.7626 16.5974 0.10738
      125 male NA NA NA 1 139.954 0.04661 -1.767 16.6376 0.1078
      126 male NA NA NA 1 140.3948 0.04667 -1.771 16.6786 0.10823
      127 male NA NA NA 1 140.8387 0.04674 -1.7745 16.7203 0.10865
      128 male NA NA NA 1 141.2859 0.0468 -1.7777 16.7628 0.10906
      129 male NA NA NA 1 141.7368 0.04686 -1.7804 16.8059 0.10948
      130 male NA NA NA 1 142.1916 0.04692 -1.7828 16.8497 0.10989
      131 male NA NA NA 1 142.6501 0.04698 -1.7847 16.8941 0.1103
      132 male NA NA NA 1 143.1126 0.04703 -1.7862 16.9392 0.1107
      133 male NA NA NA 1 143.5795 0.04709 -1.7873 16.985 0.1111
      134 male NA NA NA 1 144.0511 0.04714 -1.7881 17.0314 0.1115
      135 male NA NA NA 1 144.5276 0.04719 -1.7884 17.0784 0.11189
      136 male NA NA NA 1 145.0093 0.04723 -1.7884 17.1262 0.11228
      137 male NA NA NA 1 145.4964 0.04728 -1.788 17.1746 0.11266
      138 male NA NA NA 1 145.9891 0.04732 -1.7873 17.2236 0.11304
      139 male NA NA NA 1 146.4878 0.04736 -1.7861 17.2734 0.11342
      140 male NA NA NA 1 146.9927 0.0474 -1.7846 17.324 0.11379
      141 male NA NA NA 1 147.5041 0.04744 -1.7828 17.3752 0.11415
      142 male NA NA NA 1 148.0224 0.04747 -1.7806 17.4272 0.11451
      143 male NA NA NA 1 148.5478 0.0475 -1.778 17.4799 0.11487
      144 male NA NA NA 1 149.0807 0.04753 -1.7751 17.5334 0.11522
      145 male NA NA NA 1 149.6212 0.04755 -1.7719 17.5877 0.11556
      146 male NA NA NA 1 150.1694 0.04758 -1.7684 17.6427 0.1159
      147 male NA NA NA 1 150.7256 0.04759 -1.7645 17.6985 0.11623
      148 male NA NA NA 1 151.2899 0.04761 -1.7604 17.7551 0.11656
      149 male NA NA NA 1 151.8623 0.04762 -1.7559 17.8124 0.11688
      150 male NA NA NA 1 152.4425 0.04763 -1.7511 17.8704 0.1172
      151 male NA NA NA 1 153.0298 0.04763 -1.7461 17.9292 0.11751
      152 male NA NA NA 1 153.6234 0.04764 -1.7408 17.9887 0.11781
      153 male NA NA NA 1 154.2223 0.04763 -1.7352 18.0488 0.11811
      154 male NA NA NA 1 154.8258 0.04763 -1.7293 18.1096 0.11841
      155 male NA NA NA 1 155.4329 0.04762 -1.7232 18.171 0.11869
      156 male NA NA NA 1 156.0426 0.0476 -1.7168 18.233 0.11898
      157 male NA NA NA 1 156.6539 0.04758 -1.7102 18.2955 0.11925
      158 male NA NA NA 1 157.266 0.04756 -1.7033 18.3586 0.11952
      159 male NA NA NA 1 157.8775 0.04754 -1.6962 18.4221 0.11979
      160 male NA NA NA 1 158.4871 0.04751 -1.6888 18.486 0.12005
      161 male NA NA NA 1 159.0937 0.04747 -1.6811 18.5502 0.1203
      162 male NA NA NA 1 159.6962 0.04744 -1.6732 18.6148 0.12055
      163 male NA NA NA 1 160.2939 0.0474 -1.6651 18.6795 0.12079
      164 male NA NA NA 1 160.8861 0.04735 -1.6568 18.7445 0.12102
      165 male NA NA NA 1 161.472 0.0473 -1.6482 18.8095 0.12125
      166 male NA NA NA 1 162.0505 0.04725 -1.6394 18.8746 0.12148
      167 male NA NA NA 1 162.6207 0.0472 -1.6304 18.9398 0.1217
      168 male NA NA NA 1 163.1816 0.04714 -1.6211 19.005 0.12191
      169 male NA NA NA 1 163.7321 0.04707 -1.6116 19.0701 0.12212
      170 male NA NA NA 1 164.2717 0.04701 -1.602 19.1351 0.12233
      171 male NA NA NA 1 164.7994 0.04694 -1.5921 19.2 0.12253
      172 male NA NA NA 1 165.3145 0.04687 -1.5821 19.2648 0.12272
      173 male NA NA NA 1 165.8165 0.04679 -1.5719 19.3294 0.12291
      174 male NA NA NA 1 166.305 0.04671 -1.5615 19.3937 0.1231
      175 male NA NA NA 1 166.7799 0.04663 -1.551 19.4578 0.12328
      176 male NA NA NA 1 167.2415 0.04655 -1.5403 19.5217 0.12346
      177 male NA NA NA 1 167.6899 0.04646 -1.5294 19.5853 0.12363
      178 male NA NA NA 1 168.1255 0.04637 -1.5185 19.6486 0.1238
      179 male NA NA NA 1 168.5482 0.04628 -1.5074 19.7117 0.12396
      180 male NA NA NA 1 168.958 0.04619 -1.4961 19.7744 0.12412
      181 male NA NA NA 1 169.3549 0.04609 -1.4848 19.8367 0.12428
      182 male NA NA NA 1 169.7389 0.04599 -1.4733 19.8987 0.12443
      183 male NA NA NA 1 170.1099 0.04589 -1.4617 19.9603 0.12458
      184 male NA NA NA 1 170.468 0.04579 -1.45 20.0215 0.12473
      185 male NA NA NA 1 170.8136 0.04569 -1.4382 20.0823 0.12487
      186 male NA NA NA 1 171.1468 0.04559 -1.4263 20.1427 0.12501
      187 male NA NA NA 1 171.468 0.04548 -1.4143 20.2026 0.12514
      188 male NA NA NA 1 171.7773 0.04538 -1.4022 20.2621 0.12528
      189 male NA NA NA 1 172.0748 0.04527 -1.39 20.3211 0.12541
      190 male NA NA NA 1 172.3606 0.04516 -1.3777 20.3796 0.12554
      191 male NA NA NA 1 172.6345 0.04506 -1.3653 20.4376 0.12567
      192 male NA NA NA 1 172.8967 0.04495 -1.3529 20.4951 0.12579
      193 male NA NA NA 1 173.147 0.04484 -1.3403 20.5521 0.12591
      194 male NA NA NA 1 173.3856 0.04473 -1.3277 20.6085 0.12603
      195 male NA NA NA 1 173.6126 0.04462 -1.3149 20.6644 0.12615
      196 male NA NA NA 1 173.828 0.04451 -1.3021 20.7197 0.12627
      197 male NA NA NA 1 174.0321 0.0444 -1.2892 20.7745 0.12638
      198 male NA NA NA 1 174.2251 0.04429 -1.2762 20.8287 0.1265
      199 male NA NA NA 1 174.4071 0.04418 -1.2631 20.8824 0.12661
      200 male NA NA NA 1 174.5784 0.04407 -1.2499 20.9355 0.12672
      201 male NA NA NA 1 174.7392 0.04396 -1.2366 20.9881 0.12683
      202 male NA NA NA 1 174.8896 0.04385 -1.2233 21.04 0.12694
      203 male NA NA NA 1 175.0301 0.04375 -1.2098 21.0914 0.12704
      204 male NA NA NA 1 175.1609 0.04364 -1.1962 21.1423 0.12715
      205 male NA NA NA 1 175.2824 0.04353 -1.1826 21.1925 0.12726
      206 male NA NA NA 1 175.3951 0.04343 -1.1688 21.2423 0.12736
      207 male NA NA NA 1 175.4995 0.04332 -1.155 21.2914 0.12746
      208 male NA NA NA 1 175.5959 0.04322 -1.141 21.34 0.12756
      209 male NA NA NA 1 175.685 0.04311 -1.127 21.388 0.12767
      210 male NA NA NA 1 175.7672 0.04301 -1.1129 21.4354 0.12777
      211 male NA NA NA 1 175.8432 0.04291 -1.0986 21.4822 0.12787
      212 male NA NA NA 1 175.9133 0.04281 -1.0843 21.5285 0.12797
      213 male NA NA NA 1 175.9781 0.04271 -1.0699 21.5742 0.12807
      214 male NA NA NA 1 176.038 0.04261 -1.0553 21.6193 0.12816
      215 male NA NA NA 1 176.0935 0.04251 -1.0407 21.6638 0.12826
      216 male NA NA NA 1 176.1449 0.04241 -1.026 21.7077 0.12836
      217 male NA NA NA 1 176.1925 0.04232 -1.0112 21.751 0.12845
      218 male NA NA NA 1 176.2368 0.04222 -0.9962 21.7937 0.12855
      219 male NA NA NA 1 176.2779 0.04213 -0.9812 21.8358 0.12864
      220 male NA NA NA 1 176.3162 0.04204 -0.9661 21.8773 0.12874
      221 male NA NA NA 1 176.3518 0.04195 -0.9509 21.9182 0.12883
      222 male NA NA NA 1 176.3851 0.04185 -0.9356 21.9585 0.12893
      223 male NA NA NA 1 176.4162 0.04177 -0.9202 21.9982 0.12902
      224 male NA NA NA 1 176.4453 0.04168 -0.9048 22.0374 0.12911
      225 male NA NA NA 1 176.4724 0.04159 -0.8892 22.076 0.1292
      226 male NA NA NA 1 176.4976 0.0415 -0.8735 22.114 0.1293
      227 male NA NA NA 1 176.5211 0.04142 -0.8578 22.1514 0.12939
      228 male NA NA NA 1 176.5432 0.04134 -0.8419 22.1883 0.12948
      0 female 0.3809 3.2322 0.14171 1 49.1477 0.0379 -0.0631 13.3363 0.09272
      1 female 0.1714 4.1873 0.13724 1 53.6872 0.0364 0.3448 14.5679 0.09556
      2 female 0.0962 5.1282 0.13 1 57.0673 0.03568 0.1749 15.7679 0.09371
      3 female 0.0402 5.8458 0.12619 1 59.8029 0.0352 0.0643 16.3574 0.09254
      4 female -0.005 6.4237 0.12402 1 62.0899 0.03486 -0.0191 16.6703 0.09166
      5 female -0.043 6.8985 0.12274 1 64.0301 0.03463 -0.0864 16.8386 0.09096
      6 female -0.0756 7.297 0.12204 1 65.7311 0.03448 -0.1429 16.9083 0.09036
      7 female -0.1039 7.6422 0.12178 1 67.2873 0.03441 -0.1916 16.902 0.08984
      8 female -0.1288 7.9487 0.12181 1 68.7498 0.0344 -0.2344 16.8404 0.08939
      9 female -0.1507 8.2254 0.12199 1 70.1435 0.03444 -0.2725 16.7406 0.08898
      10 female -0.17 8.48 0.12223 1 71.4818 0.03452 -0.3068 16.6184 0.08861
      11 female -0.1872 8.7192 0.12247 1 72.771 0.03464 -0.3381 16.4875 0.08828
      12 female -0.2024 8.9481 0.12268 1 74.015 0.03479 -0.3667 16.3568 0.08797
      13 female -0.2158 9.1699 0.12283 1 75.2176 0.03496 -0.3932 16.2311 0.08768
      14 female -0.2278 9.387 0.12294 1 76.3817 0.03514 -0.4177 16.1128 0.08741
      15 female -0.2384 9.6008 0.12299 1 77.5099 0.03534 -0.4407 16.0028 0.08716
      16 female -0.2478 9.8124 0.12303 1 78.6055 0.03555 -0.4623 15.9017 0.08693
      17 female -0.2562 10.0226 0.12306 1 79.671 0.03576 -0.4825 15.8096 0.08671
      18 female -0.2637 10.2315 0.12309 1 80.7079 0.03598 -0.5017 15.7263 0.0865
      19 female -0.2703 10.4393 0.12315 1 81.7182 0.0362 -0.5199 15.6517 0.0863
      20 female -0.2762 10.6464 0.12323 1 82.7036 0.03643 -0.5372 15.5855 0.08612
      21 female -0.2815 10.8534 0.12335 1 83.6654 0.03666 -0.5537 15.5278 0.08594
      22 female -0.2862 11.0608 0.1235 1 84.604 0.03688 -0.5695 15.4787 0.08577
      23 female -0.2903 11.2688 0.12369 1 85.5202 0.03711 -0.5846 15.438 0.0856
      24 female -0.2941 11.4775 0.1239 1 85.7153 0.03764 -0.5684 15.6881 0.08454
      25 female -0.2975 11.6864 0.12414 1 86.5904 0.03786 -0.5684 15.659 0.08452
      26 female -0.3005 11.8947 0.12441 1 87.4462 0.03808 -0.5684 15.6308 0.08449
      27 female -0.3032 12.1015 0.12472 1 88.283 0.0383 -0.5684 15.6037 0.08446
      28 female -0.3057 12.3059 0.12506 1 89.1004 0.03851 -0.5684 15.5777 0.08444
      29 female -0.308 12.5073 0.12545 1 89.8991 0.03872 -0.5684 15.5523 0.08443
      30 female -0.3101 12.7055 0.12587 1 90.6797 0.03893 -0.5684 15.5276 0.08444
      31 female -0.312 12.9006 0.12633 1 91.443 0.03913 -0.5684 15.5034 0.08448
      32 female -0.3138 13.093 0.12683 1 92.1906 0.03933 -0.5684 15.4798 0.08455
      33 female -0.3155 13.2837 0.12737 1 92.9239 0.03952 -0.5684 15.4572 0.08467
      34 female -0.3171 13.4731 0.12794 1 93.6444 0.03971 -0.5684 15.4356 0.08484
      35 female -0.3186 13.6618 0.12855 1 94.3533 0.03989 -0.5684 15.4155 0.08506
      36 female -0.3201 13.8503 0.12919 1 95.0515 0.04006 -0.5684 15.3968 0.08535
      37 female -0.3216 14.0385 0.12988 1 95.7399 0.04024 -0.5684 15.3796 0.08569
      38 female -0.323 14.2265 0.13059 1 96.4187 0.04041 -0.5684 15.3638 0.08609
      39 female -0.3243 14.414 0.13135 1 97.0885 0.04057 -0.5684 15.3493 0.08654
      40 female -0.3257 14.601 0.13213 1 97.7493 0.04073 -0.5684 15.3358 0.08704
      41 female -0.327 14.7873 0.13293 1 98.4015 0.04089 -0.5684 15.3233 0.08757
      42 female -0.3283 14.9727 0.13376 1 99.0448 0.04105 -0.5684 15.3116 0.08813
      43 female -0.3296 15.1573 0.1346 1 99.6795 0.0412 -0.5684 15.3007 0.08872
      44 female -0.3309 15.341 0.13545 1 100.3058 0.04135 -0.5684 15.2905 0.08931
      45 female -0.3322 15.524 0.1363 1 100.9238 0.0415 -0.5684 15.2814 0.08991
      46 female -0.3335 15.7064 0.13716 1 101.5337 0.04164 -0.5684 15.2732 0.09051
      47 female -0.3348 15.8882 0.138 1 102.136 0.04179 -0.5684 15.2661 0.0911
      48 female -0.3361 16.0697 0.13884 1 102.7312 0.04193 -0.5684 15.2602 0.09168
      49 female -0.3374 16.2511 0.13968 1 103.3197 0.04206 -0.5684 15.2556 0.09227
      50 female -0.3387 16.4322 0.14051 1 103.9021 0.0422 -0.5684 15.2523 0.09286
      51 female -0.34 16.6133 0.14132 1 104.4786 0.04233 -0.5684 15.2503 0.09345
      52 female -0.3414 16.7942 0.14213 1 105.0494 0.04246 -0.5684 15.2496 0.09403
      53 female -0.3427 16.9748 0.14293 1 105.6148 0.04259 -0.5684 15.2502 0.0946
      54 female -0.344 17.1551 0.14371 1 106.1748 0.04272 -0.5684 15.2519 0.09515
      55 female -0.3453 17.3347 0.14448 1 106.7295 0.04285 -0.5684 15.2544 0.09568
      56 female -0.3466 17.5136 0.14525 1 107.2788 0.04298 -0.5684 15.2575 0.09618
      57 female -0.3479 17.6916 0.146 1 107.8227 0.0431 -0.5684 15.2612 0.09665
      58 female -0.3492 17.8686 0.14675 1 108.3613 0.04322 -0.5684 15.2653 0.09709
      59 female -0.3505 18.0445 0.14748 1 108.8948 0.04334 -0.5684 15.2698 0.0975
      60 female -0.3518 18.2193 0.14821 1 109.4233 0.04347 -0.5684 15.2747 0.09789
      61 female -0.4681 18.2579 0.14295 1 109.6016 0.04355 -0.8886 15.2441 0.09692
      62 female -0.4711 18.4329 0.1435 1 110.1258 0.04364 -0.9068 15.2434 0.09738
      63 female -0.4742 18.6073 0.14404 1 110.6451 0.04373 -0.9248 15.2433 0.09783
      64 female -0.4773 18.7811 0.14459 1 111.1596 0.04382 -0.9427 15.2438 0.09829
      65 female -0.4803 18.9545 0.14514 1 111.6696 0.0439 -0.9605 15.2448 0.09875
      66 female -0.4834 19.1276 0.14569 1 112.1753 0.04399 -0.978 15.2464 0.0992
      67 female -0.4864 19.3004 0.14624 1 112.6767 0.04407 -0.9954 15.2487 0.09966
      68 female -0.4894 19.473 0.14679 1 113.174 0.04415 -1.0126 15.2516 0.10012
      69 female -0.4924 19.6455 0.14735 1 113.6672 0.04423 -1.0296 15.2551 0.10058
      70 female -0.4954 19.818 0.1479 1 114.1565 0.04431 -1.0464 15.2592 0.10104
      71 female -0.4984 19.9908 0.14845 1 114.6421 0.04439 -1.063 15.2641 0.10149
      72 female -0.5013 20.1639 0.149 1 115.1244 0.04447 -1.0794 15.2697 0.10195
      73 female -0.5043 20.3377 0.14955 1 115.6039 0.04454 -1.0956 15.276 0.10241
      74 female -0.5072 20.5124 0.1501 1 116.0812 0.04461 -1.1115 15.2831 0.10287
      75 female -0.51 20.6885 0.15065 1 116.5568 0.04469 -1.1272 15.2911 0.10333
      76 female -0.5129 20.8661 0.1512 1 117.0311 0.04475 -1.1427 15.2998 0.10379
      77 female -0.5157 21.0457 0.15175 1 117.5044 0.04482 -1.1579 15.3095 0.10425
      78 female -0.5185 21.2274 0.1523 1 117.9769 0.04489 -1.1728 15.32 0.10471
      79 female -0.5213 21.4113 0.15284 1 118.4489 0.04495 -1.1875 15.3314 0.10517
      80 female -0.524 21.5979 0.15339 1 118.9208 0.04502 -1.2019 15.3439 0.10562
      81 female -0.5268 21.7872 0.15393 1 119.3926 0.04508 -1.216 15.3572 0.10608
      82 female -0.5294 21.9795 0.15448 1 119.8648 0.04514 -1.2298 15.3717 0.10654
      83 female -0.5321 22.1751 0.15502 1 120.3374 0.0452 -1.2433 15.3871 0.107
      84 female -0.5347 22.374 0.15556 1 120.8105 0.04525 -1.2565 15.4036 0.10746
      85 female -0.5372 22.5762 0.1561 1 121.2843 0.04531 -1.2693 15.4211 0.10792
      86 female -0.5398 22.7816 0.15663 1 121.7587 0.04536 -1.2819 15.4397 0.10837
      87 female -0.5423 22.9904 0.15717 1 122.2338 0.04542 -1.2941 15.4593 0.10883
      88 female -0.5447 23.2025 0.1577 1 122.7098 0.04547 -1.306 15.4798 0.10929
      89 female -0.5471 23.418 0.15823 1 123.1868 0.04551 -1.3175 15.5014 0.10974
      90 female -0.5495 23.6369 0.15876 1 123.6646 0.04556 -1.3287 15.524 0.1102
      91 female -0.5518 23.8593 0.15928 1 124.1435 0.04561 -1.3395 15.5476 0.11065
      92 female -0.5541 24.0853 0.1598 1 124.6234 0.04565 -1.3499 15.5723 0.1111
      93 female -0.5563 24.3149 0.16032 1 125.1045 0.04569 -1.36 15.5979 0.11156
      94 female -0.5585 24.5482 0.16084 1 125.5869 0.04573 -1.3697 15.6246 0.11201
      95 female -0.5606 24.7853 0.16135 1 126.0706 0.04577 -1.379 15.6523 0.11246
      96 female -0.5627 25.0262 0.16186 1 126.5558 0.04581 -1.388 15.681 0.11291
      97 female -0.5647 25.271 0.16237 1 127.0424 0.04585 -1.3966 15.7107 0.11335
      98 female -0.5667 25.5197 0.16287 1 127.5304 0.04588 -1.4047 15.7415 0.1138
      99 female -0.5686 25.7721 0.16337 1 128.0199 0.04591 -1.4125 15.7732 0.11424
      100 female -0.5704 26.0284 0.16386 1 128.5109 0.04594 -1.4199 15.8058 0.11469
      101 female -0.5722 26.2883 0.16435 1 129.0035 0.04597 -1.427 15.8394 0.11513
      102 female -0.574 26.5519 0.16483 1 129.4975 0.046 -1.4336 15.8738 0.11557
      103 female -0.5757 26.819 0.16532 1 129.9932 0.04602 -1.4398 15.909 0.11601
      104 female -0.5773 27.0896 0.16579 1 130.4904 0.04604 -1.4456 15.9451 0.11644
      105 female -0.5789 27.3635 0.16626 1 130.9891 0.04607 -1.4511 15.9818 0.11688
      106 female -0.5804 27.6406 0.16673 1 131.4895 0.04608 -1.4561 16.0194 0.11731
      107 female -0.5819 27.9208 0.16719 1 131.9912 0.0461 -1.4607 16.0575 0.11774
      108 female -0.5833 28.204 0.16764 1 132.4944 0.04612 -1.465 16.0964 0.11816
      109 female -0.5847 28.4901 0.16809 1 132.9989 0.04613 -1.4688 16.1358 0.11859
      110 female -0.5859 28.7791 0.16854 1 133.5046 0.04614 -1.4723 16.1759 0.11901
      111 female -0.5872 29.0711 0.16897 1 134.0118 0.04615 -1.4753 16.2166 0.11943
      112 female -0.5883 29.3663 0.16941 1 134.5202 0.04616 -1.478 16.258 0.11985
      113 female -0.5895 29.6646 0.16983 1 135.0299 0.04616 -1.4803 16.2999 0.12026
      114 female -0.5905 29.9663 0.17025 1 135.541 0.04617 -1.4823 16.3425 0.12067
      115 female -0.5915 30.2715 0.17066 1 136.0533 0.04617 -1.4838 16.3858 0.12108
      116 female -0.5925 30.5805 0.17107 1 136.567 0.04616 -1.485 16.4298 0.12148
      117 female -0.5934 30.8934 0.17146 1 137.0821 0.04616 -1.4859 16.4746 0.12188
      118 female -0.5942 31.2105 0.17186 1 137.5987 0.04616 -1.4864 16.52 0.12228
      119 female -0.595 31.5319 0.17224 1 138.1167 0.04615 -1.4866 16.5663 0.12268
      120 female -0.5958 31.8578 0.17262 1 138.6363 0.04614 -1.4864 16.6133 0.12307
      121 female NA NA NA 1 139.1575 0.04612 -1.4859 16.6612 0.12346
      122 female NA NA NA 1 139.6803 0.04611 -1.4851 16.71 0.12384
      123 female NA NA NA 1 140.2049 0.04609 -1.4839 16.7595 0.12422
      124 female NA NA NA 1 140.7313 0.04607 -1.4825 16.81 0.1246
      125 female NA NA NA 1 141.2594 0.04605 -1.4807 16.8614 0.12497
      126 female NA NA NA 1 141.7892 0.04603 -1.4787 16.9136 0.12534
      127 female NA NA NA 1 142.3206 0.046 -1.4763 16.9667 0.12571
      128 female NA NA NA 1 142.8534 0.04597 -1.4737 17.0208 0.12607
      129 female NA NA NA 1 143.3874 0.04594 -1.4708 17.0757 0.12643
      130 female NA NA NA 1 143.9222 0.04591 -1.4677 17.1316 0.12678
      131 female NA NA NA 1 144.4575 0.04588 -1.4642 17.1883 0.12713
      132 female NA NA NA 1 144.9929 0.04584 -1.4606 17.2459 0.12748
      133 female NA NA NA 1 145.528 0.0458 -1.4567 17.3044 0.12782
      134 female NA NA NA 1 146.0622 0.04576 -1.4526 17.3637 0.12816
      135 female NA NA NA 1 146.5951 0.04571 -1.4482 17.4238 0.12849
      136 female NA NA NA 1 147.1262 0.04567 -1.4436 17.4847 0.12882
      137 female NA NA NA 1 147.6548 0.04562 -1.4389 17.5464 0.12914
      138 female NA NA NA 1 148.1804 0.04557 -1.4339 17.6088 0.12946
      139 female NA NA NA 1 148.7023 0.04552 -1.4288 17.6719 0.12978
      140 female NA NA NA 1 149.2197 0.04546 -1.4235 17.7357 0.13009
      141 female NA NA NA 1 149.7322 0.04541 -1.418 17.8001 0.1304
      142 female NA NA NA 1 150.239 0.04535 -1.4123 17.8651 0.1307
      143 female NA NA NA 1 150.7394 0.04529 -1.4065 17.9306 0.13099
      144 female NA NA NA 1 151.2327 0.04523 -1.4006 17.9966 0.13129
      145 female NA NA NA 1 151.7182 0.04516 -1.3945 18.063 0.13158
      146 female NA NA NA 1 152.1951 0.0451 -1.3883 18.1297 0.13186
      147 female NA NA NA 1 152.6628 0.04503 -1.3819 18.1967 0.13214
      148 female NA NA NA 1 153.1206 0.04497 -1.3755 18.2639 0.13241
      149 female NA NA NA 1 153.5678 0.0449 -1.3689 18.3312 0.13268
      150 female NA NA NA 1 154.0041 0.04483 -1.3621 18.3986 0.13295
      151 female NA NA NA 1 154.429 0.04476 -1.3553 18.466 0.13321
      152 female NA NA NA 1 154.8423 0.04468 -1.3483 18.5333 0.13347
      153 female NA NA NA 1 155.2437 0.04461 -1.3413 18.6006 0.13372
      154 female NA NA NA 1 155.633 0.04454 -1.3341 18.6677 0.13397
      155 female NA NA NA 1 156.0101 0.04446 -1.3269 18.7346 0.13421
      156 female NA NA NA 1 156.3748 0.04439 -1.3195 18.8012 0.13445
      157 female NA NA NA 1 156.7269 0.04431 -1.3121 18.8675 0.13469
      158 female NA NA NA 1 157.0666 0.04423 -1.3046 18.9335 0.13492
      159 female NA NA NA 1 157.3936 0.04415 -1.297 18.9991 0.13514
      160 female NA NA NA 1 157.7082 0.04408 -1.2894 19.0642 0.13537
      161 female NA NA NA 1 158.0102 0.044 -1.2816 19.1289 0.13559
      162 female NA NA NA 1 158.2997 0.04392 -1.2739 19.1931 0.1358
      163 female NA NA NA 1 158.5771 0.04384 -1.2661 19.2567 0.13601
      164 female NA NA NA 1 158.8425 0.04376 -1.2583 19.3197 0.13622
      165 female NA NA NA 1 159.0961 0.04369 -1.2504 19.382 0.13642
      166 female NA NA NA 1 159.3382 0.04361 -1.2425 19.4437 0.13662
      167 female NA NA NA 1 159.5691 0.04353 -1.2345 19.5045 0.13681
      168 female NA NA NA 1 159.789 0.04345 -1.2266 19.5647 0.137
      169 female NA NA NA 1 159.9983 0.04337 -1.2186 19.624 0.13719
      170 female NA NA NA 1 160.1971 0.0433 -1.2107 19.6824 0.13738
      171 female NA NA NA 1 160.3857 0.04322 -1.2027 19.74 0.13756
      172 female NA NA NA 1 160.5643 0.04314 -1.1947 19.7966 0.13774
      173 female NA NA NA 1 160.7332 0.04307 -1.1867 19.8523 0.13791
      174 female NA NA NA 1 160.8927 0.04299 -1.1788 19.907 0.13808
      175 female NA NA NA 1 161.043 0.04292 -1.1708 19.9607 0.13825
      176 female NA NA NA 1 161.1845 0.04284 -1.1629 20.0133 0.13841
      177 female NA NA NA 1 161.3176 0.04277 -1.1549 20.0648 0.13858
      178 female NA NA NA 1 161.4425 0.0427 -1.147 20.1152 0.13873
      179 female NA NA NA 1 161.5596 0.04263 -1.139 20.1644 0.13889
      180 female NA NA NA 1 161.6692 0.04255 -1.1311 20.2125 0.13904
      181 female NA NA NA 1 161.7717 0.04248 -1.1232 20.2595 0.1392
      182 female NA NA NA 1 161.8673 0.04241 -1.1153 20.3053 0.13934
      183 female NA NA NA 1 161.9564 0.04235 -1.1074 20.3499 0.13949
      184 female NA NA NA 1 162.0393 0.04228 -1.0996 20.3934 0.13963
      185 female NA NA NA 1 162.1164 0.04221 -1.0917 20.4357 0.13977
      186 female NA NA NA 1 162.188 0.04214 -1.0838 20.4769 0.13991
      187 female NA NA NA 1 162.2542 0.04208 -1.076 20.517 0.14005
      188 female NA NA NA 1 162.3154 0.04201 -1.0681 20.556 0.14018
      189 female NA NA NA 1 162.3719 0.04195 -1.0603 20.5938 0.14031
      190 female NA NA NA 1 162.4239 0.04189 -1.0525 20.6306 0.14044
      191 female NA NA NA 1 162.4717 0.04182 -1.0447 20.6663 0.14057
      192 female NA NA NA 1 162.5156 0.04176 -1.0368 20.7008 0.1407
      193 female NA NA NA 1 162.556 0.0417 -1.029 20.7344 0.14082
      194 female NA NA NA 1 162.5933 0.04164 -1.0212 20.7668 0.14094
      195 female NA NA NA 1 162.6276 0.04158 -1.0134 20.7982 0.14106
      196 female NA NA NA 1 162.6594 0.04152 -1.0055 20.8286 0.14118
      197 female NA NA NA 1 162.689 0.04147 -0.9977 20.858 0.1413
      198 female NA NA NA 1 162.7165 0.04141 -0.9898 20.8863 0.14142
      199 female NA NA NA 1 162.7425 0.04136 -0.9819 20.9137 0.14153
      200 female NA NA NA 1 162.767 0.0413 -0.974 20.9401 0.14164
      201 female NA NA NA 1 162.7904 0.04125 -0.9661 20.9656 0.14176
      202 female NA NA NA 1 162.8126 0.04119 -0.9582 20.9901 0.14187
      203 female NA NA NA 1 162.834 0.04114 -0.9503 21.0138 0.14198
      204 female NA NA NA 1 162.8545 0.04109 -0.9423 21.0367 0.14208
      205 female NA NA NA 1 162.8743 0.04104 -0.9344 21.0587 0.14219
      206 female NA NA NA 1 162.8935 0.04099 -0.9264 21.0801 0.1423
      207 female NA NA NA 1 162.912 0.04094 -0.9184 21.1007 0.1424
      208 female NA NA NA 1 162.93 0.04089 -0.9104 21.1206 0.1425
      209 female NA NA NA 1 162.9476 0.04084 -0.9024 21.1399 0.14261
      210 female NA NA NA 1 162.9649 0.0408 -0.8944 21.1586 0.14271
      211 female NA NA NA 1 162.9817 0.04075 -0.8863 21.1768 0.14281
      212 female NA NA NA 1 162.9983 0.04071 -0.8783 21.1944 0.14291
      213 female NA NA NA 1 163.0144 0.04066 -0.8703 21.2116 0.14301
      214 female NA NA NA 1 163.03 0.04062 -0.8623 21.2282 0.14311
      215 female NA NA NA 1 163.0451 0.04058 -0.8542 21.2444 0.1432
      216 female NA NA NA 1 163.0595 0.04053 -0.8462 21.2603 0.1433
      217 female NA NA NA 1 163.0733 0.04049 -0.8382 21.2757 0.1434
      218 female NA NA NA 1 163.0862 0.04045 -0.8301 21.2908 0.14349
      219 female NA NA NA 1 163.0982 0.04041 -0.8221 21.3055 0.14359
      220 female NA NA NA 1 163.1092 0.04037 -0.814 21.32 0.14368
      221 female NA NA NA 1 163.1192 0.04034 -0.806 21.3341 0.14377
      222 female NA NA NA 1 163.1279 0.0403 -0.798 21.348 0.14386
      223 female NA NA NA 1 163.1355 0.04026 -0.7899 21.3617 0.14396
      224 female NA NA NA 1 163.1418 0.04023 -0.7819 21.3752 0.14405
      225 female NA NA NA 1 163.1469 0.04019 -0.7738 21.3884 0.14414
      226 female NA NA NA 1 163.1508 0.04016 -0.7658 21.4014 0.14423
      227 female NA NA NA 1 163.1534 0.04012 -0.7577 21.4143 0.14432
      228 female NA NA NA 1 163.1548 0.04009 -0.7496 21.4269 0.14441",
      header = TRUE, sep = " ", stringsAsFactors = TRUE
    )
  } else if (ref_name == "KiGGS") {
    ref <- data.table::fread(
      "age sex weight_m weight_l weight_s height_m height_l height_s bmi_m bmi_l bmi_s
        4  male   6.84   0.4510  0.1206   64.04   0.1285  0.0390  16.31   0.0710  0.0937
        5  male   7.45   0.3604  0.1186   66.37   0.1119  0.0375  16.73   0.0306  0.0929
        6  male   7.96   0.2774  0.1169   68.37   0.0959  0.0363  16.97  -0.0093  0.0922
        7  male   8.40   0.2022  0.1155   70.10   0.0806  0.0354  17.10  -0.0493  0.0914
        8  male   8.79   0.1344  0.1144   71.63   0.0661  0.0347  17.18  -0.0898  0.0907
        9  male   9.15   0.0734  0.1135   73.01   0.0524  0.0341  17.22  -0.1299  0.0900
       10  male   9.47   0.0188  0.1128   74.28   0.0395  0.0337  17.23  -0.1700  0.0893
       11  male   9.76  -0.0302  0.1123   75.48   0.0276  0.0335  17.18  -0.2108  0.0885
       12  male  10.03  -0.0743  0.1119   76.63   0.0167  0.0334  17.09  -0.2513  0.0878
       15  male  10.75  -0.1852  0.1112   79.88  -0.0111  0.0337  16.89  -0.3745  0.0858
       18  male  11.41  -0.2778  0.1110   82.88  -0.0320  0.0342  16.65  -0.5004  0.0840
       21  male  12.05  -0.3615  0.1113   85.66  -0.0472  0.0348  16.46  -0.6297  0.0823
       24  male  12.68  -0.4393  0.1117   88.21  -0.058   0.0352  16.34  -0.7629  0.0808
       30  male  13.87  -0.5809  0.1132   92.88  -0.0698  0.0362  16.12  -1.0418  0.0784
       36  male  15.03  -0.7111  0.1152   97.14  -0.0713  0.0375  15.94  -1.3293  0.0768
       42  male  16.14  -0.8285  0.1177  101.00  -0.0646  0.0385  15.79  -1.6090  0.0761
       48  male  17.15  -0.9304  0.1206  104.56  -0.0512  0.0393  15.64  -1.8650  0.0767
       54  male  18.07  -1.0182  0.1239  107.94  -0.0320  0.0400  15.52  -2.0866  0.0786
       60  male  19.05  -1.1032  0.1279  111.23  -0.0075  0.0407  15.44  -2.2676  0.0819
       66  male  20.19  -1.1897  0.1330  114.51   0.0219  0.0412  15.45  -2.4052  0.0864
       72  male  21.50  -1.2711  0.1392  117.78   0.0562  0.0416  15.53  -2.4979  0.0919
       78  male  22.98  -1.3401  0.1463  121.13   0.0960  0.0417  15.65  -2.5461  0.0981
       84  male  24.58  -1.3868  0.1537  124.51   0.1413  0.0419  15.81  -2.5517  0.1048
       90  male  26.17  -1.4057  0.1610  127.77   0.1915  0.0420  16.00  -2.5191  0.1116
       96  male  27.66  -1.4002  0.1676  130.79   0.2448  0.0424  16.21  -2.4550  0.1183
      102  male  29.25  -1.3757  0.1738  133.62   0.3008  0.0428  16.46  -2.3674  0.1247
      108  male  31.00  -1.3340  0.1797  136.35   0.3598  0.0434  16.74  -2.2651  0.1307
      114  male  32.84  -1.2770  0.1855  138.98   0.4219  0.0442  17.04  -2.1564  0.1361
      120  male  34.79  -1.2054  0.1915  141.55   0.4881  0.0452  17.36  -2.0488  0.1410
      126  male  36.81  -1.1198  0.1980  144.09   0.5590  0.0464  17.68  -1.9481  0.1454
      132  male  38.88  -1.0215  0.2047  146.68   0.6371  0.0478  17.99  -1.8589  0.1491
      138  male  41.00  -0.9131  0.2111  149.35   0.7246  0.0492  18.30  -1.7843  0.1522
      144  male  43.25  -0.8021  0.2166  152.22   0.8249  0.0505  18.60  -1.7260  0.1546
      150  male  45.82  -0.6980  0.2209  155.43   0.9434  0.0517  18.90  -1.6839  0.1562
      156  male  48.81  -0.6193  0.2231  159.13   1.0830  0.0523  19.21  -1.6563  0.1571
      162  male  52.14  -0.5799  0.2222  163.10   1.2386  0.0520  19.52  -1.6402  0.1572
      168  male  55.51  -0.5842  0.2170  166.93   1.3973  0.0505  19.83  -1.6319  0.1567
      174  male  58.75  -0.6427  0.2074  170.35   1.5454  0.0481  20.15  -1.6279  0.1557
      180  male  61.69  -0.7319  0.1953  173.12   1.6711  0.0452  20.47  -1.6259  0.1542
      186  male  64.26  -0.8264  0.1832  175.20   1.7691  0.0426  20.79  -1.6246  0.1525
      192  male  66.30  -0.9088  0.1740  176.66   1.8391  0.0405  21.10  -1.6239  0.1505
      198  male  67.87  -0.9795  0.1680  177.62   1.8857  0.0391  21.42  -1.6242  0.1484
      204  male  69.15  -1.0401  0.1641  178.24   1.9158  0.0382  21.72  -1.6257  0.1464
      210  male  70.30  -1.0959  0.1613  178.68   1.9374  0.0376  22.03  -1.6281  0.1443
      216  male  71.39  -1.1482  0.1591  179.04   1.9551  0.0371  22.31  -1.6308  0.1424
       4  female 6.25 0.0417 0.119 62.3 1 0.0404 15.73 0.0701 0.0917
       5  female 6.82 -0.0074 0.1158 64.54 1 0.0391 16.16 0.0019 0.091
       6  female 7.3 -0.0549 0.1134 66.48 1 0.0379 16.46 -0.0653 0.0903
       7  female 7.72 -0.1013 0.1116 68.19 1 0.0369 16.65 -0.1325 0.0896
       8  female 8.09 -0.1469 0.1103 69.73 1 0.0361 16.74 -0.2003 0.0889
       9  female 8.43 -0.1904 0.1094 71.16 1 0.0355 16.76 -0.2671 0.0882
       10 female 8.75 -0.2321 0.1088 72.53 1 0.035 16.74 -0.3336 0.0875
       11 female 9.06 -0.2724 0.1084 73.84 1 0.0347 16.71 -0.4005 0.0869
       12 female 9.34 -0.3101 0.1082 75.09 1 0.0344 16.66 -0.4662 0.0862
       15 female 10.1 -0.411 0.1083 78.54 1 0.0342 16.48 -0.6606 0.0844
       18 female 10.76 -0.4923 0.109 81.59 1 0.0346 16.26 -0.8479 0.0829
       21 female 11.35 -0.5556 0.1099 84.28 1 0.0351 16.09 -1.0257 0.0817
       24 female 11.95 -0.6039 0.111 86.73 1 0.0356 15.99 -1.1922 0.0809
       30 female 13.18 -0.6711 0.1144 91.34 1 0.0364 15.83 -1.485 0.0805
       36 female 14.42 -0.7236 0.1189 95.75 1 0.0372 15.71 -1.7197 0.0813
       42 female 15.54 -0.7783 0.1231 99.79 1 0.0379 15.6 -1.8974 0.083
       48 female 16.6 -0.8367 0.1273 103.51 1 0.0385 15.51 -2.0239 0.0851
       54 female 17.69 -0.8939 0.1315 107.15 1 0.0393 15.44 -2.1066 0.0876
       60 female 18.84 -0.9453 0.1358 110.82 1 0.0399 15.41 -2.1531 0.0904
       66 female 20.06 -0.9871 0.1401 114.31 1 0.0404 15.42 -2.1703 0.0937
       72 female 21.35 -1.0172 0.1448 117.59 1 0.0409 15.49 -2.1641 0.0976
       78 female 22.7 -1.034 0.1503 120.69 1 0.0414 15.6 -2.1391 0.1025
       84 female 24.06 -1.0369 0.1566 123.65 1 0.042 15.75 -2.0995 0.1083
       90 female 25.48 -1.0259 0.1639 126.56 1 0.0427 15.94 -2.0487 0.115
       96 female 27.01 -1.0011 0.1723 129.49 1 0.0434 16.15 -1.9898 0.1225
      102 female 28.69 -0.9637 0.1817 132.4 1 0.0442 16.41 -1.9259 0.1304
      108 female 30.55 -0.915 0.1915 135.28 1 0.045 16.69 -1.8601 0.1383
      114 female 32.57 -0.8581 0.2014 138.18 1 0.0457 16.99 -1.7953 0.1457
      120 female 34.68 -0.7974 0.2111 141.18 1 0.0462 17.31 -1.7345 0.1523
      126 female 36.92 -0.7394 0.2192 144.33 1 0.0463 17.64 -1.6803 0.1578
      132 female 39.37 -0.6929 0.2247 147.65 1 0.0461 18 -1.6351 0.1617
      138 female 42.05 -0.6675 0.2258 151.04 1 0.0454 18.37 -1.6009 0.164
      144 female 44.87 -0.6719 0.2218 154.31 1 0.0443 18.77 -1.5791 0.1647
      150 female 47.59 -0.7108 0.2142 157.22 1 0.043 19.17 -1.5706 0.1641
      156 female 50.02 -0.7827 0.2046 159.53 1 0.0418 19.57 -1.5758 0.1623
      162 female 52.16 -0.8798 0.1948 161.33 1 0.0409 19.94 -1.5943 0.1598
      168 female 54.01 -0.9906 0.1856 162.74 1 0.0401 20.3 -1.6252 0.1568
      174 female 55.55 -1.1027 0.1776 163.81 1 0.0395 20.62 -1.6672 0.1536
      180 female 56.8 -1.2062 0.1712 164.58 1 0.0391 20.91 -1.7187 0.1503
      186 female 57.79 -1.2946 0.166 165.09 1 0.0389 21.16 -1.7778 0.1471
      192 female 58.53 -1.3656 0.1622 165.39 1 0.0387 21.37 -1.8427 0.1442
      198 female 59.07 -1.4208 0.1595 165.5 1 0.0387 21.55 -1.9117 0.1414
      204 female 59.47 -1.4641 0.1575 165.54 1 0.0386 21.7 -1.983 0.1389
      210 female 59.78 -1.5008 0.1559 165.65 1 0.0386 21.83 -2.0556 0.1366
      216 female 60.08 -1.534 0.1545 165.77 1 0.0385 21.95 -2.1259 0.1345",
      header = TRUE, sep = " ", stringsAsFactors = TRUE
    )
  } else if (ref_name == "Kromeyer-Hauschild") {
    ref_KiGGS <- data.table::fread(
      "age sex weight_m  weight_l weight_s height_m height_l height_s bmi_m bmi_l bmi_s
         4  male   6.84   0.4510  0.1206   64.04   0.1285  0.0390  16.31   0.0710  0.0937
         5  male   7.45   0.3604  0.1186   66.37   0.1119  0.0375  16.73   0.0306  0.0929
         6  male   7.96   0.2774  0.1169   68.37   0.0959  0.0363  16.97  -0.0093  0.0922
         7  male   8.40   0.2022  0.1155   70.10   0.0806  0.0354  17.10  -0.0493  0.0914
         8  male   8.79   0.1344  0.1144   71.63   0.0661  0.0347  17.18  -0.0898  0.0907
         9  male   9.15   0.0734  0.1135   73.01   0.0524  0.0341  17.22  -0.1299  0.0900
        10  male   9.47   0.0188  0.1128   74.28   0.0395  0.0337  17.23  -0.1700  0.0893
        11  male   9.76  -0.0302  0.1123   75.48   0.0276  0.0335  17.18  -0.2108  0.0885
        12  male  10.03  -0.0743  0.1119   76.63   0.0167  0.0334  17.09  -0.2513  0.0878
        15  male  10.75  -0.1852  0.1112   79.88  -0.0111  0.0337  16.89  -0.3745  0.0858
        18  male  11.41  -0.2778  0.1110   82.88  -0.0320  0.0342  16.65  -0.5004  0.0840
        21  male  12.05  -0.3615  0.1113   85.66  -0.0472  0.0348  16.46  -0.6297  0.0823
        24  male  12.68  -0.4393  0.1117   88.21  -0.058   0.0352  16.34  -0.7629  0.0808
        30  male  13.87  -0.5809  0.1132   92.88  -0.0698  0.0362  16.12  -1.0418  0.0784
        36  male  15.03  -0.7111  0.1152   97.14  -0.0713  0.0375  15.94  -1.3293  0.0768
        42  male  16.14  -0.8285  0.1177  101.00  -0.0646  0.0385  15.79  -1.6090  0.0761
        48  male  17.15  -0.9304  0.1206  104.56  -0.0512  0.0393  15.64  -1.8650  0.0767
        54  male  18.07  -1.0182  0.1239  107.94  -0.0320  0.0400  15.52  -2.0866  0.0786
        60  male  19.05  -1.1032  0.1279  111.23  -0.0075  0.0407  15.44  -2.2676  0.0819
        66  male  20.19  -1.1897  0.1330  114.51   0.0219  0.0412  15.45  -2.4052  0.0864
        72  male  21.50  -1.2711  0.1392  117.78   0.0562  0.0416  15.53  -2.4979  0.0919
        78  male  22.98  -1.3401  0.1463  121.13   0.0960  0.0417  15.65  -2.5461  0.0981
        84  male  24.58  -1.3868  0.1537  124.51   0.1413  0.0419  15.81  -2.5517  0.1048
        90  male  26.17  -1.4057  0.1610  127.77   0.1915  0.0420  16.00  -2.5191  0.1116
        96  male  27.66  -1.4002  0.1676  130.79   0.2448  0.0424  16.21  -2.4550  0.1183
       102  male  29.25  -1.3757  0.1738  133.62   0.3008  0.0428  16.46  -2.3674  0.1247
       108  male  31.00  -1.3340  0.1797  136.35   0.3598  0.0434  16.74  -2.2651  0.1307
       114  male  32.84  -1.2770  0.1855  138.98   0.4219  0.0442  17.04  -2.1564  0.1361
       120  male  34.79  -1.2054  0.1915  141.55   0.4881  0.0452  17.36  -2.0488  0.1410
       126  male  36.81  -1.1198  0.1980  144.09   0.5590  0.0464  17.68  -1.9481  0.1454
       132  male  38.88  -1.0215  0.2047  146.68   0.6371  0.0478  17.99  -1.8589  0.1491
       138  male  41.00  -0.9131  0.2111  149.35   0.7246  0.0492  18.30  -1.7843  0.1522
       144  male  43.25  -0.8021  0.2166  152.22   0.8249  0.0505  18.60  -1.7260  0.1546
       150  male  45.82  -0.6980  0.2209  155.43   0.9434  0.0517  18.90  -1.6839  0.1562
       156  male  48.81  -0.6193  0.2231  159.13   1.0830  0.0523  19.21  -1.6563  0.1571
       162  male  52.14  -0.5799  0.2222  163.10   1.2386  0.0520  19.52  -1.6402  0.1572
       168  male  55.51  -0.5842  0.2170  166.93   1.3973  0.0505  19.83  -1.6319  0.1567
       174  male  58.75  -0.6427  0.2074  170.35   1.5454  0.0481  20.15  -1.6279  0.1557
       180  male  61.69  -0.7319  0.1953  173.12   1.6711  0.0452  20.47  -1.6259  0.1542
       186  male  64.26  -0.8264  0.1832  175.20   1.7691  0.0426  20.79  -1.6246  0.1525
       192  male  66.30  -0.9088  0.1740  176.66   1.8391  0.0405  21.10  -1.6239  0.1505
       198  male  67.87  -0.9795  0.1680  177.62   1.8857  0.0391  21.42  -1.6242  0.1484
       204  male  69.15  -1.0401  0.1641  178.24   1.9158  0.0382  21.72  -1.6257  0.1464
       210  male  70.30  -1.0959  0.1613  178.68   1.9374  0.0376  22.03  -1.6281  0.1443
       216  male  71.39  -1.1482  0.1591  179.04   1.9551  0.0371  22.31  -1.6308  0.1424
        4  female 6.25 0.0417 0.119 62.3 1 0.0404 15.73 0.0701 0.0917
        5  female 6.82 -0.0074 0.1158 64.54 1 0.0391 16.16 0.0019 0.091
        6  female 7.3 -0.0549 0.1134 66.48 1 0.0379 16.46 -0.0653 0.0903
        7  female 7.72 -0.1013 0.1116 68.19 1 0.0369 16.65 -0.1325 0.0896
        8  female 8.09 -0.1469 0.1103 69.73 1 0.0361 16.74 -0.2003 0.0889
        9  female 8.43 -0.1904 0.1094 71.16 1 0.0355 16.76 -0.2671 0.0882
        10 female 8.75 -0.2321 0.1088 72.53 1 0.035 16.74 -0.3336 0.0875
        11 female 9.06 -0.2724 0.1084 73.84 1 0.0347 16.71 -0.4005 0.0869
        12 female 9.34 -0.3101 0.1082 75.09 1 0.0344 16.66 -0.4662 0.0862
        15 female 10.1 -0.411 0.1083 78.54 1 0.0342 16.48 -0.6606 0.0844
        18 female 10.76 -0.4923 0.109 81.59 1 0.0346 16.26 -0.8479 0.0829
        21 female 11.35 -0.5556 0.1099 84.28 1 0.0351 16.09 -1.0257 0.0817
        24 female 11.95 -0.6039 0.111 86.73 1 0.0356 15.99 -1.1922 0.0809
        30 female 13.18 -0.6711 0.1144 91.34 1 0.0364 15.83 -1.485 0.0805
        36 female 14.42 -0.7236 0.1189 95.75 1 0.0372 15.71 -1.7197 0.0813
        42 female 15.54 -0.7783 0.1231 99.79 1 0.0379 15.6 -1.8974 0.083
        48 female 16.6 -0.8367 0.1273 103.51 1 0.0385 15.51 -2.0239 0.0851
        54 female 17.69 -0.8939 0.1315 107.15 1 0.0393 15.44 -2.1066 0.0876
        60 female 18.84 -0.9453 0.1358 110.82 1 0.0399 15.41 -2.1531 0.0904
        66 female 20.06 -0.9871 0.1401 114.31 1 0.0404 15.42 -2.1703 0.0937
        72 female 21.35 -1.0172 0.1448 117.59 1 0.0409 15.49 -2.1641 0.0976
        78 female 22.7 -1.034 0.1503 120.69 1 0.0414 15.6 -2.1391 0.1025
        84 female 24.06 -1.0369 0.1566 123.65 1 0.042 15.75 -2.0995 0.1083
        90 female 25.48 -1.0259 0.1639 126.56 1 0.0427 15.94 -2.0487 0.115
        96 female 27.01 -1.0011 0.1723 129.49 1 0.0434 16.15 -1.9898 0.1225
       102 female 28.69 -0.9637 0.1817 132.4 1 0.0442 16.41 -1.9259 0.1304
       108 female 30.55 -0.915 0.1915 135.28 1 0.045 16.69 -1.8601 0.1383
       114 female 32.57 -0.8581 0.2014 138.18 1 0.0457 16.99 -1.7953 0.1457
       120 female 34.68 -0.7974 0.2111 141.18 1 0.0462 17.31 -1.7345 0.1523
       126 female 36.92 -0.7394 0.2192 144.33 1 0.0463 17.64 -1.6803 0.1578
       132 female 39.37 -0.6929 0.2247 147.65 1 0.0461 18 -1.6351 0.1617
       138 female 42.05 -0.6675 0.2258 151.04 1 0.0454 18.37 -1.6009 0.164
       144 female 44.87 -0.6719 0.2218 154.31 1 0.0443 18.77 -1.5791 0.1647
       150 female 47.59 -0.7108 0.2142 157.22 1 0.043 19.17 -1.5706 0.1641
       156 female 50.02 -0.7827 0.2046 159.53 1 0.0418 19.57 -1.5758 0.1623
       162 female 52.16 -0.8798 0.1948 161.33 1 0.0409 19.94 -1.5943 0.1598
       168 female 54.01 -0.9906 0.1856 162.74 1 0.0401 20.3 -1.6252 0.1568
       174 female 55.55 -1.1027 0.1776 163.81 1 0.0395 20.62 -1.6672 0.1536
       180 female 56.8 -1.2062 0.1712 164.58 1 0.0391 20.91 -1.7187 0.1503
       186 female 57.79 -1.2946 0.166 165.09 1 0.0389 21.16 -1.7778 0.1471
       192 female 58.53 -1.3656 0.1622 165.39 1 0.0387 21.37 -1.8427 0.1442
       198 female 59.07 -1.4208 0.1595 165.5 1 0.0387 21.55 -1.9117 0.1414
       204 female 59.47 -1.4641 0.1575 165.54 1 0.0386 21.7 -1.983 0.1389
       210 female 59.78 -1.5008 0.1559 165.65 1 0.0386 21.83 -2.0556 0.1366
       216 female 60.08 -1.534 0.1545 165.77 1 0.0385 21.95 -2.1259 0.1345",
      header = TRUE, sep = " ", stringsAsFactors = TRUE
    )
    ref_Kromeyer <- data.table::fread(
      "sex,     age,  height_l, height_m,  height_sd, height_s,    weight_p10, weight_m, weight_p90,   bmi_l,  bmi_m, bmi_s, bmi_p97
       female,    0,  1.00,     51.1,      2.3,       0.04500978,    2.7,        3.3,       3.9,       +1.34,  12.6,  0.097, 14.8
       female,    3,  1.00,     59.1,      2.5,       0.04230118,    4.1,        5.0,       5.9,       +0.29,  15.4,  0.084, 18.0
       female,    6,  1.00,     66.2,      2.7,       0.04078550,    6.0,        7.2,       8.4,       -0.03,  16.2,  0.082, 18.9
       female,    9,  1.00,     71.4,      2.8,       0.03921569,    6.5,        7.7,       9.2,       -0.26,  16.4,  0.081, 19.1
       female,   12,  1.00,     75.4,      2.9,       0.03846154,    7.9,        9.4,      11.0,       -0.44,  16.4,  0.081, 19.2
       female,   18,  1.00,     81.5,      3.1,       0.03803681,    9.2,       10.8,      12.8,       -0.71,  16.2,  0.084, 19.2
       female,   24,  1.00,     86.6,      3.4,       0.03926097,   10.2,       12.0,      14.2,       -0.92,  15.9,  0.087, 19.0
       female,   36,  1.00,     95.5,      4.0,       0.04188482,   12.0,       14.0,      16.9,       -1.19,  15.5,  0.091, 18.8
       female,   48,  1.00,     103.6,     4.1,       0.03957529,   13.9,       16.4,      19.8,       -1.38,  15.3,  0.096, 18.9
       female,   60,  1.00,     111.0,     4.8,       0.04324324,   15.8,       18.8,      23.1,       -1.52,  15.3,  0.101, 19.2
       female,   72,  1.00,     117.9,     5.1,       0.04325700,   17.8,       21.3,      26.5,       -1.62,  15.4,  0.108, 19.7
       female,   84,  1.00,     123.6,     5.4,       0.04368932,   19.6,       23.6,      29.9,       -1.66,  15.6,  0.115, 20.4
       female,   96,  1.00,     129.1,     5.7,       0.04415182,   21.8,       26.7,      34.2,       -1.64,  16.0,  0.124, 21.5
       female,  108,  1.00,     135.6,     6.2,       0.04572271,   24.6,       30.4,      39.3,       -1.58,  16.5,  0.131, 22.5
       female,  120,  1.00,     141.3,     6.8,       0.04812456,   27.0,       34.8,      44.2,       -1.51,  16.9,  0.138, 23.5
       female,  132,  1.00,     147.1,     7.3,       0.04962610,   29.7,       37.4,      49.8,       -1.43,  17.5,  0.142, 24.5
       female,  144,  1.00,     153.7,     7.5,       0.04879636,   33.4,       42.9,      56.2,       -1.36,  18.2,  0.144, 25.5
       female,  156,  1.00,     159.3,     8.3,       0.05210295,   38.3,       48.2,      62.0,       -1.30,  18.9,  0.143, 26.3
       female,  168,  1.00,     163.0,     9.4,       0.05766871,   42.9,       52.7,      66.5,       -1.25,  19.6,  0.140, 27.0
       female,  180,  1.00,     165.1,     7.4,       0.04482132,   60.5,       69.3,      86.9,       -1.20,  20.2,  0.136, 27.5
       female,  192,  1.00,     166.2,     6.4,       0.03850782,   74.7,       79.5,      97.0,       -1.16,  20.6,  0.132, 27.7
       female,  204,  1.00,     167.2,     5.4,       0.03229665,   90.5,       89.3,     107.7,       -1.11,  21.0,  0.128, 27.7
       female,  216,  1.00,     168.2,     4.4,       0.02615933,   97.5,       97.8,     114.2,       -1.07,  21.3,  0.124, 27.8
       male,      0,  1.00,      51.5,     2.4,       0.04660194,    2.7,        3.4,       4.0,       +1.31,  12.7,  0.101, 15.0
       male,      3,  1.00,      60.6,     2.7,       0.04455446,    4.4,        5.0,       6.0,       -0.33,  16.0,  0.088, 18.9
       male,      6,  1.00,      67.9,     2.9,       0.04270987,    6.5,        7.5,       9.3,       -0.67,  16.7,  0.084, 19.7
       male,      9,  1.00,      72.8,     3.0,       0.04120879,    7.7,        8.7,      11.9,       -0.89,  16.8,  0.082, 19.9
       male,     12,  1.00,      76.7,     3.2,       0.04172099,    9.5,       10.9,      14.3,       -1.05,  16.8,  0.081, 19.8
       male,     18,  1.00,      82.9,     3.3,       0.03980700,   11.4,       12.9,      16.5,       -1.28,  16.4,  0.081, 19.5
       male,     24,  1.00,      88.1,     3.5,       0.03972758,   13.0,       15.0,      18.3,       -1.45,  16.1,  0.082, 19.1
       male,     36,  1.00,      96.5,     4.0,       0.04145078,   15.1,       17.6,      21.5,       -1.67,  15.6,  0.085, 18.8
       male,     48,  1.00,     104.1,     4.4,       0.04226705,   17.2,       20.1,      24.8,       -1.80,  15.5,  0.088, 18.8
       male,     60,  1.00,     111.7,     4.8,       0.04297225,   19.5,       22.8,      28.4,       -1.88,  15.4,  0.093, 19.0
       male,     72,  1.00,     118.4,     5.1,       0.04307432,   21.8,       25.5,      32.0,       -1.92,  15.4,  0.099, 19.4
       male,     84,  1.00,     124.4,     5.4,       0.04340836,   20.2,       24.1,      30.0,       -1.92,  15.7,  0.106, 20.2
       male,     96,  1.00,     129.9,     5.7,       0.04387991,   22.4,       27.0,      34.0,       -1.91,  16.0,  0.114, 21.1
       male,    108,  1.00,     136.4,     6.2,       0.04545455,   25.1,       30.5,      39.1,       -1.87,  16.4,  0.123, 22.2
       male,    120,  1.00,     141.6,     6.7,       0.04731638,   27.5,       33.8,      44.0,       -1.83,  16.9,  0.130, 23.4
       male,    132,  1.00,     146.2,     7.3,       0.04993160,   29.8,       37.2,      49.0,       -1.77,  17.4,  0.136, 24.5
       male,    144,  1.00,     151.8,     8.0,       0.05270092,   32.6,       41.5,      55.4,       -1.72,  18.0,  0.139, 25.4
       male,    156,  1.00,     159.1,     8.5,       0.05342552,   36.5,       47.3,      63.3,       -1.66,  18.6,  0.139, 26.3
       male,    168,  1.00,     166.5,     8.5,       0.05105105,   41.9,       53.9,      71.1,       -1.61,  19.3,  0.138, 27.0
       male,    180,  1.00,     172.6,     8.0,       0.04634994,   47.8,       59.9,      76.7,       -1.55,  19.9,  0.136, 27.5
       male,    192,  1.00,     176.6,     7.5,       0.04246886,   52.8,       64.3,      80.3,       -1.49,  20.5,  0.133, 28.0
       male,    204,  1.00,     179.3,     7.1,       0.03959844,   57.0,       68.0,      83.3,       -1.44,  21.0,  0.130, 28.4
       male,    216,  1.00,     180.7,     6.8,       0.03763143,   59.7,       70.6,      85.4,       -1.39,  21.6,  0.126, 28.8",
      header = TRUE, sep = ",", stringsAsFactors = TRUE
    )
    ref <- merge(
      ref_KiGGS[, list(age, sex, weight_m, weight_l, weight_s)],
      ref_Kromeyer[, list(age, sex, height_m, height_l, height_s, bmi_m, bmi_l, bmi_s)],
      all = TRUE, by = c("sex", "age")
    )
    if (na_omit) {
      ref <- na_omit(ref)
    }
  } else {
    stop("Unknown reference name")
  }
  return(ref)
}

#' \name{interpolate_reference}
#' \alias{interpolate_reference}
#' \usage{interpolate_reference(ref_name, years, step)}
#' \title{Interpolate reference values}
#' \description{Takes a reference dataset and interpolates it to a given age range.}
#' \details{
#' Based on the reference dataset, the age range and the age step, the function
#' linearly interpolates the reference values.
#' }
#' \arguments{
#'   \item{ref_name}{A string specifying the reference to be interpolated.
#' Possible values are "WHO", "KiGGS" and "Kromeyer". Default: "WHO".}
#'   \item{years}{Age range to be interpolated. Default: c(0, 18)}
#'   \item{step}{Age step to be used for interpolation. Default: 0.01}
#' }
#' \value{ Interpolated reference dataset. }

interpolate_reference <- function(ref_name=c("WHO", "KiGGS", "Kromeyer-Hauschild"),
                                  years = c(0, 18),
                                  step = 0.01
) {
  sex <- age <- height_l <- height_m <- height_s <- weight_l <- weight_m <- weight_s <- bmi_l <- bmi_m <- bmi_s <- NULL

  # Check, whether the reference is given
  ref_name <- match.arg(ref_name)

  # Load reference
  ref <- load_reference(ref_name)

  # From months to year, not good, better to change the format of the
  # reference dataset to include units
  # TODO: Check, whether the reference is in months or years based on units
  if (max(ref[, age]) > 20) ref[, age := age / 12]

  # Set age range to be used for interpolation
  age_interp <- seq(min(years), max(years), abs(step))

  # Create vector of sexes to be interpolated
  slvl <- c("female", "male")

  # Allocate LMS parameters to be interpolated
  interp_lms <- data.table(
    sex = factor(rep(slvl, each = length(age_interp)), levels = slvl),
    age = rep(age_interp, 2),
    height_l = -1000, height_m = -1000, height_s = -1000,
    weight_l = -1000, weight_m = -1000, weight_s = -1000,
    bmi_l = -1000, bmi_m = -1000, bmi_s = -1000
  )

  # Linearly interpolate LMS parameters
  for (s in interp_lms[, levels(sex)]) {
    interp_lms[sex == s, height_l := approx(x=ref[sex == s, age], y=ref[sex == s, height_l], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, height_m := approx(x=ref[sex == s, age], y=ref[sex == s, height_m], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, height_s := approx(x=ref[sex == s, age], y=ref[sex == s, height_s], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, weight_l := approx(x=ref[sex == s, age], y=ref[sex == s, weight_l], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, weight_m := approx(x=ref[sex == s, age], y=ref[sex == s, weight_m], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, weight_s := approx(x=ref[sex == s, age], y=ref[sex == s, weight_s], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, bmi_l := approx(x=ref[sex == s, age], y=ref[sex == s, bmi_l], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, bmi_m := approx(x=ref[sex == s, age], y=ref[sex == s, bmi_m], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
    interp_lms[sex == s, bmi_s := approx(x=ref[sex == s, age], y=ref[sex == s, bmi_s], xout=interp_lms[sex == s, age], na.rm=TRUE)$y]
  }

  # Round ages to 2 digits to avoid rounding errors
  interp_lms[, age := round(age, 2)]

  return(interp_lms)
}

#' \name{interpolate_cutoffs}
#' \alias{interpolate_cutoffs}
#' \usage{interpolate_cutoffs(ref_name, cutoffs, groups, years, step)}
#' \title{Interpolation of percentile BMI cutoffs}
#' \description{Interpolate percentile BMI cutoffs for a given reference.}
#' \details{
#'  The function linearly interpolates percentile cutoffs for a given reference based on the
#'  International Obesity Task Force (IOTF) cutoffs. The reference is interpolated to the age range
#'  defined by `years` and `step`. The function returns a `data.table` with the
#'  percentile cutoffs.
#' }
#' \arguments{
#'   \item{ref_name}{Reference name. Either "WHO", "KiGGS" or "Kromeyer-Hauschild". Default: "WHO".}
#'   \item{cutoffs}{Cutoffs.}
#'   \item{groups}{Names of the weight groups.}
#'   \item{years}{Age range in years.}
#'   \item{step}{Age step.}
#' }
#' \value{`data.table` of percentile cutoffs.}
#' \references{
#' Cole, MJ, "The LMS method for constructing normalized growth standards",
#' European journal of clinical nutrition 44, 1 (1990), pp. 45-60.
#' }
#' \seealso{\code{\link{interpolate_reference}}}

interpolate_cutoffs <- function(ref_name = c("WHO", "KiGGS", "Kromeyer-Hauschild"),
                                cutoffs = c(18.5, 25.0, 30.0),
                                groups = c("underweight", "overweight", "obese"),
                                years = c(0, 18),
                                step = 0.01
) {
  sex <- age <- height_l <- height_m <- height_s <- weight_l <- weight_m <- weight_s <- bmi_l <- bmi_m <- bmi_s <- z <- bmi_centile <- status <- NULL

  # Check, whether the reference is given
  ref_name <- match.arg(ref_name)

  # Interpolated LMS parameter table
  interp_lms <- interpolate_reference(
    ref_name = ref_name, years = years, step = step)[, list(sex, age, bmi_l, bmi_m, bmi_s)]

  # Calculate interpolated percentile cutoffs based on cutoffs at age 18
  prms <- interp_lms[age == 18, list(bmi_l, bmi_m, bmi_s), by = sex]
  cts <- prms[, list(z = transform_to_zscore(cutoffs, l = bmi_l, m = bmi_m, s = bmi_s)), by = sex]

  # Repeat the interpolated parameters as many times as cutoffs
  # for each sex
  tmp <- vector("list", length = length(interp_lms[, levels(sex)]))

  for (s in interp_lms[, levels(sex)]) {
    tmp[[s]] <- interp_lms[sex == s, list(
      age = rep(age, times = length(cutoffs)),
      sex = rep(sex, times = length(cutoffs)),
      bmi_l = rep(bmi_l, times = length(cutoffs)),
      bmi_m = rep(bmi_m, times = length(cutoffs)),
      bmi_s = rep(bmi_s, times = length(cutoffs)),
      z = cts[sex == s, list(z = rep(z, each = nrow(interp_lms[sex == s, ])))][, z],
      status = rep(groups, each = nrow(interp_lms[sex == s, ])))
    ]
  }

  # Collect sex specific data
  res <- rbind(tmp[[interp_lms[, levels(sex)][1]]], tmp[[interp_lms[, levels(sex)][1]]])

  # Convert status to factor
  res[, status := factor(status, levels = groups)]

  # Transform to bmi centiles
  res <- res[, bmi_centile := transform_to_centile(z, bmi_l, bmi_m, bmi_s)]

  return(res)
}

#' \name{adiposity_status_bmi}
#' \alias{adiposity_status_bmi}
#' \title{Weight status assignment}
#' \description{Assigns a weight status for each observation in the data.}
#' \details{
#' Based on given BMI cutoffs, the adiposity status for each observation is determined.
#' The argument `cutoffs` must be a named list of 2-element vectors:
#' The first element denotes the lower (inclusive) bound, while the second element
#' denotes the upper (exclusive) bound.
#' }
#' \arguments{
#'   \item{cresc_data}{A data.table containing CrescNet data.}
#'   \item{ref_name}{Reference name. Either "WHO", "KiGGS" or "Kromeyer-Hauschild". Default: "WHO".}
#'   \item{bounds}{A named list with BMI cutoffs given as a 2-element vector. Default: list(underweight = c(NA, 18.5), normal = c(18.5, 25), overweight = c(25, 30), obese = c(30, NA))}
#'   \item{years}{Age range in years. Default: c(0, 18)}
#'   \item{step}{Age step. Default: 0.01}
#' }
#' \value{A data.table containing an extra column with the assigned weight status for each observation.}

# TODO: Put this function and the other one for BMI-SDS together
adiposity_status_bmi <- function(cresc_data,
                               ref_name = c("WHO", "KiGGS", "Kromeyer-Hauschild"),
                               bounds = list(underweight = c(NA, 18.5), normal = c(18.5, 25), overweight = c(25, 30), obese = c(30, NA)),
                               years = c(0, 18),
                               step = 0.01
) {
  bmi <- sex <- tmp_id <- age <- status <- bmi_centile <- idxlow <- idxup <- cutlow <- cutup <- st <- s <- NULL

  # Collapse the cutoffs to a vector
  cutoffs <- unlist(bounds)

  # Interpolation reference cutoffs
  cuttab <- interpolate_cutoffs(ref_name = ref_name,
                                cutoffs = cutoffs,
                                groups = names(cutoffs),
                                years = years,
                                step = step)[, list(age, sex, status, bmi_centile)]

  # Temporary id column
  cuttab[, tmp_id := seq(1, .N, 1)]

  # Alocation of the status
  cresc_data[, status := ""]
  cresc_data[, tmp_id := seq(1, .N, 1)]
  setkey(cresc_data, age)       # Sort DT in place
  cresc_data[, .SD, by = list(age)]

  # Split by sexes
  tmp <- list(female = cresc_data[sex == levels(sex)[1], ],
              male = cresc_data[sex == levels(sex)[2], ])

  # Go trough all adiposity status
  for (st in names(bounds)) {
    for (s in cresc_data[, levels(sex)]) {

      # Get the lower and upper bound
      cutlow <- cuttab[sex == s & status == paste0(st, "1"), ]
      cutup <- cuttab[sex == s & status == paste0(st, "2"), ]

      # Index for relevant ages and sex
      idxlow <- cresc_data[sex == s, findInterval(age, cutlow[, age])]
      idxup <- cresc_data[sex == s, findInterval(age, cutup[, age])]

      # Get the BMI
      bmilow <- if (cutlow[idxlow, !all(is.na(bmi_centile))]) cutlow[idxlow, bmi_centile] else 0
      bmiup <- if (cutup[idxup, !all(is.na(bmi_centile))]) cutup[idxup, bmi_centile] else .Machine$integer.max

      # Update data.table
      tmp[[s]][bmi >= bmilow & bmi < bmiup, status := st]
    }
  }

  # Tidy up
  res <- rbind(tmp[[cresc_data[, levels(sex)][1]]], tmp[[cresc_data[, levels(sex)][2]]])
  res <- res[, .SD, keyby = tmp_id]

  return(res[, tmp_id := NULL])
}

#' \name{adiposity_status_bmi_sds}
#' \alias{adiposity_status_bmi_sds}
#' \usage{adiposity_status_bmi_sds(cresc_data, cutoffs)}
#' \title{Weight status assignment}
#' \description{Assigns a weight status for each observation in the data.}
#' \details{
#' Based on given percentile cutoffs and categories, each observation is categorized.
#' The argument `cutoffs` must be a named list of lists:
#' The first list denotes the category, while the second list includes following entries
#' with the following named entries: `lower`, `upper`, `inclower`, `incupper`, i.e. the
#' lower / upper bound (as a numeric value), whether the lower / upper bounds should be
#' inclusive or not (as a boolean), respectively. `lower` and `upper` are mandatory, while
#' the two other entries are not. If not given, the default assumes inclusive bounds.
#' }
#' \arguments{
#'   \item{cresc_data}{A data.table containing CrescNet data.}
#'   \item{cutoffs}{BMI cutoffs used.}
#' }
#' \value{A data.table containing an extra column with the assigned weight status for each observation.}

adiposity_status_bmi_sds <- function(cresc_data,
                                     cutoffs = list(
                                       underweight = list(lower=NA, upper=qnorm(0.05), inclower=TRUE, incupper=FALSE),
                                       normal = list(lower=qnorm(0.05), upper=qnorm(0.85), inclower=TRUE, incupper=FALSE),
                                       overweight = list(lower=qnorm(0.85), upper=qnorm(0.95), inclower=TRUE, incupper=FALSE),
                                       obese = list(lower=qnorm(0.95), upper=NA, inclower=TRUE, incupper=FALSE))
) {
    if (class(cutoffs) != "list") {
      stop("Argument 'cutoffs' must be a list.")
    } else if (length(cutoffs) == 0) {
      stop("Argument 'cutoffs' must contain at least one element.")
    } else if (is.null(names(cutoffs))) {
        stop("Argument 'cutoffs' must be a named list (category) with each element being a named list (list arguments) itself.")
    }

    status <- bmi_sds <- NULL
    cresc_data[, status := ""]
    nms <- names(cutoffs)

    # Find & assign end status
    # TODO: Check the bounds, e.g. the next higher status should
    # be inclusive of the lower bound and exclusive the upper bound
    # at the moment it is inclusive lower and upper bound
    for (nm in nms) {
      catg <- names(cutoffs[[nm]])

      if (!all(c("lower", "upper") %in% catg)) {
        stop("Each named list element of 'cutoffs' must be itself a named list with at least the elements 'upper' and 'lower'. See details in ?catergorize_by_endpoint.")
      }

      lower <- if (is.na(cutoffs[[nm]]$lower)) -.Machine$integer.max else cutoffs[[nm]]$lower
      upper <- if (is.na(cutoffs[[nm]]$upper)) .Machine$integer.max else cutoffs[[nm]]$upper

      if (all(c("inclower", "incupper") %in% catg)) {
        inclower <- cutoffs[[nm]]$inclower
        incupper <- cutoffs[[nm]]$incupper

        if (inclower & incupper) {
          cresc_data[between(bmi_sds, lower, upper, incbounds = TRUE), status := nm]
        } else if (inclower & !incupper) {
            cresc_data[`>=`(bmi_sds, lower) & `<`(bmi_sds, upper), status := nm]
        } else if (!inclower & incupper) {
            cresc_data[`>`(bmi_sds, lower) & `<=`(bmi_sds, upper), status := nm]
        } else cresc_data[between(bmi_sds, lower, upper, incbounds = FALSE), status := nm]
      } else cresc_data[between(bmi_sds, lower, upper, incbounds = TRUE), status := nm]
    }

    return(cresc_data[, status := factor(status, levels = nms)])
}

#' \name{assign_median_bmi}
#' \alias{assign_median_bmi}
#' \usage{assign_median_bmi(cresc_data, ref_name)}
#' \title{Assign median BMI}
#' \description{Assign median BMI for a given reference.}
#' \details{
#'  Assigning the interpolated BMI median for a given reference for
#'  age and sex adjustment.
#' }
#' \arguments{
#'   \item{cresc_data}{Input data.frame.}
#'   \item{ref_name}{Reference name. Either "WHO", "KiGGS" or "Kromeyer-Hauschild". Default: "WHO".}
#' }
#' \value{`data.table` with BMI median.}

assign_median_bmi <- function(cresc_data, ref_name = c("WHO", "KiGGS", "Kromeyer-Hauschild")) {

  # Assign global variables
  sex <- age <- bmi <- bmi_m <- NULL

  ref_name <- match.arg(ref_name)

  # Interpolate reference
  interp_lms <- interpolate_reference(ref_name)

  # Allocate BMI to be interpolated
  cresc_data[, bmi_m := -1000];

  # Map the age the interpolated LMS parameters
  ref_indices_female <- interp_lms[, which(sex == levels(sex)[1])] - 1
  ref_indices_male <- interp_lms[, which(sex == levels(sex)[2])] - 1

  bmimed <- assignMedianBmiCpp(
    cresc_data[, bmi], cresc_data[, age],
    cresc_data[, sex], interp_lms[, age],
    interp_lms[, bmi_m], ref_indices_female,
    ref_indices_male
  )

  cresc_data[, bmi_m := bmimed]

  return(cresc_data)
}

#' \name{prepare_dataset}
#' \alias{prepare_dataset}
#' \usage{prepare_dataset(file_obese, file_control, ref_name, n_train,
#' center_age, use_days, encode_sex, use_short_ids, include_baseline, seed)}
#' \title{Loading an preprocessing of the CrescNet dataset.}
#' \description{
#' Transform the raw measurements of z-scores.
#' }
#' \details{The functions expects file paths to specific CrescNet data with the variables
#' 'subject_id', 'sex', 'gestational_age', 'age', 'height', 'weight', 'height_sds',
#' 'bmi', 'bmi_sds' and 'age_group'. Next to raw measurements, Z-scores for 'weight',
#' 'height' and 'bmi' will be given based on the specified reference. Additionally options include
#' the number of subjects used for training and testing the model, next to several options to for
#' transforming variables.
#'
#' }
#' \arguments{
#'   \item{file_obese}{CrescNet file path for obese labeled subjects.}
#'   \item{file_control}{CrescNet file path for control labeled subjects.}
#'   \item{ref_name}{Which reference to use.}
#'   \item{n_train}{Number of samples used for model building.}
#'   \item{center_age}{Should age be centered? Default: FALSE}
#'   \item{use_days}{Age given in days, instead of years? Default: FALSE}
#'   \item{encode_sex}{Sex encoded as 1 (male) and -1 (female)? Default: FALSE}
#'   \item{use_short_ids}{Shorter subject IDs? Default: TRUE}
#'   \item{include_baseline}{First measurements as separate variables? Default: TRUE}
#'   \item{seed}{Seed used for random sampling of subjects. Default: 1}
#' }
#' \value{
#'  A data.frame contraining all variables of the CrescNet dataset.
#' }

prepare_dataset <- function(file_obese,
                            file_control,
                            ref_name=c("WHO", "KiGGS", "Kromeyer-Hauschild"),
                            n_train = 100,
                            center_age = FALSE,
                            use_days = FALSE,
                            encode_sex = FALSE,
                            use_short_ids = TRUE,
                            include_baseline = TRUE,
                            seed = 1
) {
  # Define variables
  # Fix issues with R CMD check by defining each variable used in the data.table locally
  new_id <- N <- bmi_sds_alt <- weight_sds_alt <- height_sds_alt <- NULL
  subject_id <- age <- type <- sex <- age_group <- measurement_id <- dupl_age <- NULL
  height <- height_l <- height_m <- height_s <- NULL
  weight <- weight_l <- weight_m <- weight_s <- NULL
  bmi <- bmi_l <- bmi_m <- bmi_s <- NULL

  # Check, whether the reference is given
  ref_name <- match.arg(ref_name)

  # Loading CrescNet data & pool data sets
  obese <- data.table::fread(file_obese, header=TRUE)[, type := "obese*"]
  control <- data.table::fread(file_control, header=TRUE)[, type := "control*"]
  cresc_data <- rbind(obese, control)

  # Interpolate reference
  interp_lms <- interpolate_reference(ref_name)

  # Allocate BMI to be interpolated
  cresc_data[, bmi_sds_alt := -1000];
  cresc_data[, height_sds_alt := -1000];
  cresc_data[, weight_sds_alt := -1000];

  # Map the age the interpolated LMS parameters
  ref_indices_female <- interp_lms[, which(sex == levels(sex)[1])] - 1
  ref_indices_male <- interp_lms[, which(sex == levels(sex)[2])] - 1

  height_sds_new <- calculateZscoresCpp(
    cresc_data[, height], cresc_data[, age], cresc_data[, sex],
    interp_lms[, age], interp_lms[, height_l], interp_lms[, height_m], interp_lms[, height_s],
    ref_indices_female, ref_indices_male
  )

  weight_sds_new <- calculateZscoresCpp(
    cresc_data[, weight], cresc_data[, age], cresc_data[, sex],
    interp_lms[, age], interp_lms[, weight_l], interp_lms[, weight_m], interp_lms[, weight_s],
    ref_indices_female, ref_indices_male
  )

  bmi_sds_new <- calculateZscoresCpp(
    cresc_data[, bmi], cresc_data[, age], cresc_data[, sex],
    interp_lms[, age], interp_lms[, bmi_l], interp_lms[, bmi_m], interp_lms[, bmi_s],
    ref_indices_female, ref_indices_male
  )

  # Update data.table
  cresc_data[, weight_sds_alt := weight_sds_new]
  cresc_data[, height_sds_alt := height_sds_new]
  cresc_data[, bmi_sds_alt := bmi_sds_new]

  # TODO: CHECK THE RESULTS OF THE FOLLOWING FUNCTION CALLS, PROBABLY REMOVE THEM
  # Transform to Z-scores using given reference
  # Note, that age is given in months in the reference
  # TODO: Sex information is missing
  # Hot fix: Included the sex indices - 1 for C++
  # ref_indices_female <- ref[, which(sex == levels(sex)[1])] - 1
  # ref_indices_male <- ref[, which(sex == levels(sex)[2])] - 1

  # height_sds_new <- interpolateToZscoreCpp(
  #   cresc_data[, height], cresc_data[, age * 12], cresc_data[, sex],
  #   ref[, age], ref[, height_l], ref[, height_m], ref[, height_s],
  #   ref_indices_female, ref_indices_male
  # )

  # weight_sds_new <- interpolateToZscoreCpp(
  #   cresc_data[, weight], cresc_data[, age * 12], cresc_data[, sex],
  #   ref[, age], ref[, weight_l], ref[, weight_m], ref[, weight_s],
  #   ref_indices_female, ref_indices_male
  # )

  # bmi_sds_new <- interpolateToZscoreCpp(
  #   cresc_data[, bmi], cresc_data[, age * 12], cresc_data[, sex],
  #   ref[, age], ref[, bmi_l], ref[, bmi_m], ref[, bmi_s],
  #   ref_indices_female, ref_indices_male
  # )

  # # Update data.table
  # cresc_data[, weight_sds_new := weight_sds_new]
  # cresc_data[, height_sds_new := height_sds_new]
  # cresc_data[, bmi_sds_new := bmi_sds_new]

  # Set shorter ids
  if (use_short_ids) {
    tmp <- cresc_data[, .N, by=subject_id]
    tmp[, new_id := mcgraph::mcg.autonames("ID_", length(cresc_data[, unique(subject_id)]))]
    cresc_data[, subject_id := tmp[, rep(new_id, N)]]
  }

  # Introduce factors
  cresc_data[, sex := factor(sex, levels = c("female", "male"))]
  cresc_data[, type := factor(type, levels = c("control*", "obese*"))]
  setnames(cresc_data, "gestational_age", "gest_age")

  # Encode sex continous over a range of -1 to 1 from male to female
  if (encode_sex) {
    cresc_data[, sex := unlist(lapply(sex, function(x) return(if (x == "male") 1 else -1)))]
  }

  # Center age
  if (center_age) {
    cresc_data[, age := age - (max(age) - ((max(age) - min(age)) / 2))]
  }

  if (include_baseline) {
    # Get response at baseline, i.e. first measurement at approx age 0.5 years
    # Note: use list instead of . to avoid NOTE when R CMD check
    start <- cresc_data[age_group == "start", list(subject_id, age, weight, height, bmi)]
    setnames(start, c("age", "weight", "height", "bmi"), c("age0", "weight0", "height0", "bmi0"))
    after <- cresc_data[age_group != "start", ]

    # Set keys for faster access / merging cresc_data_cp
    setkey(start, subject_id)
    cresc_data <- Hmisc::Merge(start, after, id = ~ subject_id, verbose = FALSE)
  }

  # Find & remove duplicated observations
  # Must copy explicitly because of self reference
  # Remove duplicated ages, i.e. double measurements,
  # TODO: Maybe average them better?
  cresc_data_cp <- copy(cresc_data)
  cresc_data <- cresc_data_cp[,  dupl_age := duplicated(age), by = subject_id]
  cresc_data <- cresc_data[dupl_age == FALSE, ]
  cresc_data[, dupl_age := NULL]

  # Enumerate measurements with ID
  cresc_data[, measurement_id := seq(1, length(weight), 1), by = subject_id]

  # Get age in days
  if (use_days) {
    cresc_data <- cresc_data[, age := floor(age * 365.25)]
  }

  # Draw randomly subjects
  set.seed(seed)
  rndidx <- sample(seq(1, length(cresc_data[, unique(subject_id)]), 1), size = n_train)
  ids <- cresc_data[, unique(subject_id)][rndidx]

  # Split into test and training set for internal validation
  crescData_train <- cresc_data[subject_id %in% ids, ]
  cresc_data_test <- cresc_data[!(subject_id %in% ids), ]

  return(list(train = crescData_train, test = cresc_data_test))
}

#' \name{create_age_cohorts}
#' \alias{create_age_cohorts}
#' \title{Create age cohorts}
#' \description{
#' Creating age cohorts.
#' }
#' \details{
#'   Based on the CrescNet data, different age cohorts are created
#'   using given boundaries. The boundaries are given in form of a `matrix`.
#' }
#' \arguments{
#'   \item{cresc_data}{A `data.frame` with CrescNet data.}
#'   \item{age_range}{A 2*n `matrix` with age boundaries.}
#' }
#' \value{
#'   `list` with as much entries as age cohorts.
#' }

create_age_cohorts <- function(cresc_data, age_range) {
  age <- NULL

  # Assign age ranges to observations
  age_cohorts <- getAgeCohortsCpp(cresc_data[, age], age_range)

  # Create levels
  y <- gl(
    nrow(age_range), 1, nrow(age_range),
    labels=paste0(age_range[, 1], "-", age_range[, 2], " years")
  )

  # Exclude those subject, which have not been assigned to a age group
  idx <- which(age_cohorts$age_lower == 0 & age_cohorts$age_upper == 0)

  # Exclude non assigned subjects
  res <- if (length(idx) != 0) {
    # Create factors for each group but exclude to assigned subjects
    age_range <- factor(paste0(age_cohorts$age_lower[-idx], "-", age_cohorts$age_upper[-idx], " years"), levels=levels(y))
    cbind(cresc_data[-idx, ], age_range=age_range)
  } else {
    # Create factors for each group
    age_range <- factor(paste0(age_cohorts$age_lower, "-", age_cohorts$age_upper, " years"), levels=levels(y))
    cbind(cresc_data, age_range=age_range)
  }

  return(res)
}

#' \name{do_simulation}
#' \alias{do_simulation}
#' \title{Run a sampling simulation to emulate CrescNet data filtering}
#' \description{
#' Running a simulation based on the general properties of the CrescNet in use.
#' }
#' \details{
#' Simulation function to investigate the effect of the stratified sampling, i.e.
#' the use of split criteria on the association of the BMI mean and standard deviation (SD).
#'
#' }
#' \arguments{
#' \item{cresc_data:}{A `data.frame` with CrescNet data.}
#' \item{n_subjects:}{Number of simulated subjects. Default: 1000.}
#' \item{k:}{Number of observations per subject. Default: 20.}
#' \item{n_pop:}{Number of observations in the population. Default: 1e5.}
#' \item{split:}{Split criterion. Default: 0.97.}
#' }
#' \value{
#' A `list` with with two data.tables: `sample` and `aggregated`.
#' }

do_simulation <- function(cresc_data, n_subjects = 1000, k = 20, n_pop = 1e5, split = 0.97) {
    bmi_sds <- mean_var <- mu_bmi <- sd_var <- subject_id <- type <- var_bmi <- NULL

    # Get the BMI-SDS variability for each groups
    varsubj <- cresc_data[, list(sd=sd(bmi_sds)), by = .(subject_id, type)]

    # Collect the mean and standard deviation of the variabiliy
    varpars <- varsubj[, list(mean_var = mean(sd), sd_var = sd(sd)), by = .(type)]

    # Define a normal distribution representing the overall population with the empirical variability
    # of each subpopulation
    pop <- varpars[, list(mu_bmi = rnorm(n_pop, 0, 1), var_bmi = rnorm(n_pop, mean_var, sd_var)), by = type]
    pop[, subject_id := mcg.autonames("ID_", n = .N)]

    # Sample artificial subjects with k observations with mu and sigma from each distribution
    # This is too slow right now
    bmi_pop <- pop[, list(bmi_sds = rnorm(k, mu_bmi, abs(var_bmi))), by = subject_id]

    # Simulate 97th centile selection re assign type
    pop_ob_subj <- bmi_pop[which(bmi_sds > qnorm(split, 0, 1)), unique(subject_id)]
    bmi_pop[subject_id %in% pop_ob_subj, type := "Obese*"]
    bmi_pop[!(subject_id %in% pop_ob_subj), type := "Control*"]

    subs_ob_subj <- sample(pop_ob_subj, n_subjects)
    subs_ctrl_subj <- sample(bmi_pop[!(subject_id %in% pop_ob_subj), subject_id], n_subjects)

    # Sample of 1000 subjects
    sampl <- bmi_pop[subject_id %in% c(subs_ob_subj, subs_ctrl_subj), .SD]
    agg <- sampl[, .(mean = mean(bmi_sds), sd = sd(bmi_sds)), by = list(subject_id, type)]

    return(list(sample = sampl, aggregated = agg))
}

#' \name{check_model}
#' \alias{check_model}
#' \title{Checking mixed-effects model}
#' \description{Model check applying common checks for model assessment.}
#' \usage{check_model(model, cresc_data, seed)}
#' \arguments{
#'   \item{model}{A `gls` model.}
#'   \item{cresc_data}{CrescNet data.table}
#'   \item{seed}{The seed for extracting the 20 randomly drawn subjects. Default: 1}
#' }
#' \details{
#' The usually model checks are applied, i.e. (1) constant variance residuals check, (2) random distributed residuals,
#' (3) goodness of fit by plotting fitted values against the outcome variable, (4) the variogram for observing the intra-subject correlation
#' and (5) plotting fitted values against the standardized residuals.
#' }
#' \value{Series of `ggplot` plots.}

check_model <- function(model, cresc_data, seed = 1) {
  tmp <- copy(cresc_data)
  bmi <- fitted <- resid <- subject_id <- rndidx <- age <- weight <- NULL

  # Define plotting settings
  blue <- "#5499C7"
  # t <- theme_bw(base_size = 12, base_family = "Fira Sans") %+replace%
  # theme(plot.title = element_text(hjust = 0.5))
  t <- theme_elegant()

  # Update initial data table
  if (class(model) == "brmsfit") {
    # The resid is simply the difference between the raw value and the fitted estimate
    fi <- fitted(model)
    tmp[, resid := model$data[, 1] - fi[, 1]]
    tmp[, fitted := fi[, 1]]
  } else {
    tmp[, resid := resid(model)]
    tmp[, fitted := fitted(model)]
  }

  set.seed(seed)
  min_size <- if (length(tmp[, unique(subject_id)]) < 20) length(tmp[, unique(subject_id)]) else 20
  rndidx <- sample(tmp[, unique(subject_id)], size = min_size)

  # ASSUMPTION 1: CONSTANT VARIANCE
  # Check, whether the expection is 0 and the variability is constant
  p1 <- ggplot(tmp[subject_id %in% rndidx, ], aes(subject_id, resid)) +
    geom_boxplot() +
    coord_flip() +
    geom_abline(slope = 0, intercept = 0, colour = "red") +
    labs(title = expression(bold("Residuals per subject")), x = "Subject id", y = "Standardized residuals") +
    t

  # ASSUMPTION 2: RANDOM DISTRIBUTION OF RESIDUALS AROUND MEAN OF 0 AND STANDARD DEVIATION OF 1
  # Check the residuals by subject
  p2 <- ggplot(tmp[subject_id %in% rndidx, ], aes(x = fitted, y = resid, group = subject_id)) +
    geom_point(colour = blue) +
    geom_line(colour = blue) +
    facet_wrap(~ subject_id) +
    labs(title = expression(bold("Deviation from fit")), x = "Fitted", y = "Standardized residuals") +
    t

  # DIAGNOSTICS PLOT: GOODNESS OF FIT FOR RAW RESPONSE VALUES
  # Fitted line against raw values
  p3 <- ggplot(tmp[subject_id %in% rndidx, ], aes(x = age, bmi)) +
    geom_point() +
    geom_line(mapping = aes(x = age, y = fitted), colour = blue) +
    facet_wrap(~ subject_id) +
    labs(title = expression(bold("Fitted vs response")), x = "Age", y = "Response") +
    t

  if (class(model) != "brmsfit") {
    # DIAGNOSTICS PLOT: NO TREND IN WITHIN-SUBJECT CORRELATIONS
    # Variogram for checking the correlations
    p4 <- ggvario(Variogram(model, resType = "n"))
  }

  # DIAGNOSTICS PLOT: FITTED VS RESIDUALS
  p5 <- ggplot(tmp, aes(x = fitted, y = resid)) +
    geom_point(colour = blue) +
    labs(title = expression(bold("Fitted vs response")), x = "Fitted", y = "Standardized residuals") +
    t

  # Print plots sequentially
  pr <- "Enter key for next plot:"
  readline(pr); print(p1)
  readline(pr); print(p2)
  readline(pr); print(p3)
  if (class(model) != "brmsfit") { readline(pr); print(p4) }
  readline(pr); print(p5)
}

#' \name{make_predictions}
#' \alias{make_predictions}
#' \title{Generate predictions}
#' \description{Uses the given GLS model to make predictions for 20 subjects.}
#' \usage{make_predictions(model, cresc_data, seed, log)}
#' \arguments{
#'   \item{model}{A `gls` model.}
#'   \item{cresc_data}{CrescNet data.table}
#'   \item{seed}{Seed for extracting the 20 randomly drawn subjects. Default: 1}
#'   \item{log}{Should the logarithm for the response be used? Default: TRUE}
#' }
#' \details{
#' The function can be used to observe, how the model fits body weights of
#' 20 randomly selected subjects of a test set. Next to a `ggplot` plot
#' with fits for each subject, the estimated weight values are appended
#' to the initilal data.table object.
#' }
#' \value{A `ggplot` object and a `data.table` with prediction estimates.}

make_predictions <- function(model, cresc_data, seed = 1, log = TRUE) {
  subject_id <- age <- predicted <- weight <- NULL

  blue <- "#5499C7"
  set.seed(seed)

  cresc_data_test <- cresc_data$test[
    subject_id %in% sample(cresc_data$test[, unique(subject_id)], size = 20),
  ]

  cresc_data_test[, predicted := predict(model, cresc_data_test)]

  g <- if (log) {
    ggplot(cresc_data_test, aes(x = age, log(weight)))
  } else {
    ggplot(cresc_data_test, aes(x = age, weight))
  }

  g <- g +
    geom_point() +
    geom_line(mapping = aes(x = age, y = predicted), colour = blue) +
    labs(title = expression(bold("Using the GLS model to predict test data"))) +
    facet_wrap(~ subject_id) +
    theme_bw()

  print(g)

  return(cresc_data_test)
}

#' \name{ggvario}
#' \alias{ggvario}
#' \title{Plot a variogram}
#' \description{Uses ggplot to plot a variogram}
#' \usage{ggvario(v)}
#' \arguments{
#'   \item{v}{A data.frame object with columns `dist` and `variog`.}
#' }
#' \details{
#' The column `dist` contains the distances, while `variog` is the the result
#' of the variogram function.
#' }
#' \value{A `ggplot` object.}

ggvario <- function(v) {
  variog <- type <- NULL

  g <- ggplot(v, aes(x = dist, y = variog))
  g <- g +
    geom_point() +
    expand_limits(y = 0) +
    geom_smooth(method = "loess", span = 1) +
    labs(title = expression(bold("Variogram")), x = "lag (years)", y = expression(gamma(lag))) +
    theme_bw(base_family = "Fira Sans")
  g <- if ("type" %in% colnames(v)) g + facet_wrap(vars(type)) else g
  return(g)
}

#' \name{theme_elegant}
#' \alias{theme_elegant}
#' \title{Custom ggplot theme}
#' \description{A customized ggplot theme}
#' \usage{
#' theme_elegant(base_size, base_family, axis.line, axis.line.x, axis.line.y,
#' legend.title, legend.position, legend.direction, legend.justification,
#' legend.box, panel.background, panel.border, panel.grid, plot.background, strip.background,
#' strip.text, strip.text.y)
#' }
#' \arguments{
#'   \item{base_size}{The base font size.}
#'   \item{base_family}{The base font family.}
#'   \item{axis.line}{The line of the axis.}
#'   \item{axis.line.x}{The line of the axis in x direction.}
#'   \item{axis.line.y}{The line of the axis in y direction.}
#'   \item{legend.title}{The title of the legend.}
#'   \item{legend.position}{The position of the legend.}
#'   \item{legend.direction}{The direction of the legend.}
#'   \item{legend.justification}{The justification of the legend.}
#'   \item{legend.box}{The box of the legend.}
#'   \item{panel.background}{The background of the panel.}
#'   \item{panel.border}{The border of the panel.}
#'   \item{panel.grid}{The grid of the panel.}
#'   \item{plot.background}{The background of the plot.}
#'   \item{strip.background}{The background of the strip.}
#'   \item{strip.text}{The text of the strip.}
#'   \item{strip.text.y}{The text of the strip in y direction.}
#' }
#' \details{
#' A customized ggplot theme.
#' }
#' \value{A `ggplot` theme.}

theme_elegant <- function(base_size = 11,
                          base_family ="Fira Sans",
                          axis.line = element_blank(),#element_line(colour = "black", linewidth = 0.25),
                          axis.line.x = NULL,#element_line(colour = "black", linewidth = 0.25),
                          axis.line.y = NULL,#element_line(colour = "black", linewidth = 0.25),
                          legend.title = element_blank(),
                          legend.position = "bottom",
                          legend.direction = "horizontal",
                          legend.justification = "center",
                          legend.box = "horizontal",
                          panel.background = element_blank(),#element_rect(fill = NA, colour = NA),
                          panel.border = element_rect(fill = NA, colour = "black", linewidth = 0.75),
                          panel.grid = element_line(colour = "grey92", linewidth = 0.25, linetype = "solid"),
                          plot.background = element_blank(),#element_rect(fill = "white", colour = "white"),
                          strip.background = element_rect(fill = "white", colour = "white"),
                          strip.text = element_text(face ="plain",
                                                    size = rel(0.8),
                                                    hjust = 0.5,
                                                    margin = margin(0.4, 0.4, 0.4, 0.4, unit = "cm")),
                          strip.text.y = element_text(angle = 0,
                                                      margin = margin(0.4, 0.4, 0.4, 0.4, unit = "cm"))
) {
    theme_bw(base_size = base_size, base_family = base_family) %+replace%
    theme(
        axis.line = axis.line,
        axis.line.x = axis.line.x,
        axis.line.y = axis.line.y,
        legend.position = legend.position,
        legend.direction = legend.direction,
        legend.justification = legend.justification,
        legend.title = legend.title,
        legend.box = legend.box,
        panel.background = panel.background,
        panel.border = panel.border,
        panel.grid = panel.grid,
        plot.background = plot.background,
        strip.background = strip.background,
        strip.placement ="outside",
        strip.text = strip.text,
        strip.text.y = strip.text.y,
    )
}

# DOCUMENTATION FOR C++ CODE
#-------------------------------------------------------------------------
#' \name{getIndicesCpp}
#' \alias{getIndicesCpp}
#' \title{Retrieve the pair of indices for linear interpolation.}
#' \usage{getIndicesCpp(...)}
#' \description{Retrieve the indices for the interpolation of the
#' LMS parameters
#' }
#' \details{
#' The references for the raw measurements only are given for discrete
#' months values, such that for ages in-between, the L, M and S parameters
#' must be interpolated. For simplicity, the values are linearly interpolated.
#' For this reason, the indices for the lower and upper bound in the proximity
#' of the the values of interest must be found by this function.
#' }
#' \arguments{
#' \item{...}{Arguments.}
#' }
#' \value{
#'  The relevant indices for interpolation.
#' }

getIndicesCpp <- function(...) {
  return(getIndicesCpp(...))
}

#' \name{getProportionCpp}
#' \alias{getProportionCpp}
#' \title{Calculate the proportion factor for precise interpolation.}
#' \usage{getProportionCpp(...)}
#' \description{
#'  Get the relative proportion, which is necessary for interpolation.
#' }
#' \details{
#' The references for the raw measurements only are given for discrete
#' months values, such that for ages in-between, the L, M and S parameters
#' must be interpolated. For simplicity, the values are linearly interpolated.
#' For this reason, the indices for the lower and upper bound
#' in the proximity of the the values of interest must be found by this
#' function.
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \value{
#' The proportion of the difference between the lower / upper
#' reference age bound and the difference of the the age of the child to the
#' upper reference age bound.
#' }
#' \seealso{See also \code{\link{getIndicesCpp}}}

getProportionCpp <- function(...) {
  return(getProportionCpp(...))
}

#' \name{calculateZScoreCpp}
#' \alias{calculateZScoreCpp}
#' \title{z-score transformation}
#' \usage{calculateZScoreCpp(...)}
#' \description{Transform raw biometrical measurements to z-scores}
#' \details{
#' Given the LMS parameters and raw measurements for weight, height or BMI,
#' the given values are transformed to z-values, based on the
#' LMS method of Cole (1991), which is commonly applied for
#' growth curve analysis.
#' }
#' \arguments{
#'   \item{...}{Arguments.}
#' }
#' \value{`vector` of transformed values.}
#' \references{Cole, TJ,
#' "The LMS method for constructing normalized growth standards",
#' European journal of clinical nutrition 44, 1 (1990), pp. 45-60.}

calculateZScoreCpp <- function(...) {
  return(calculateZScoreCpp(...))
}

#' \name{calculateZscoresCpp}
#' \alias{calculateZscoresCpp}
#' \title{z-score transformation}
#' \usage{calculateZscoresCpp(...)}
#' \description{Transform raw biometrical measurements to z-scores}
#' \details{
#' Given the LMS parameters and raw measurements for weight, height or BMI,
#' the given values are transformed to z-values, based on the
#' LMS method of Cole (1991), which is commonly applied for
#' growth curve analysis.
#' }
#' \arguments{
#'   \item{...}{Arguments.}
#' }
#' \value{`vector` of transformed values.}
#' \references{Cole, TJ,
#' "The LMS method for constructing normalized growth standards",
#' European journal of clinical nutrition 44, 1 (1990), pp. 45-60.}
calculateZscoresCpp <- function(...) {
  return(calculateZscoresCpp(...))
}

#' \name{findAgeIndicesCpp}
#' \alias{findAgeIndicesCpp}
#' \title{Find the indices for the interpolation of the LMS parameters.}
#' \usage{findAgeIndicesCpp(...)}
#' \description{Find the indices for the interpolation of the LMS parameters.}
#' \details{
#' The references for the raw measurements only are given for discrete
#' months or years values, such that for ages in-between, the L, M and S parameters
#' must be interpolated. For simplicity, the values are linearly interpolated.
#' For this reason, the indices for the lower and upper bound
#' in the proximity of the the values of interest must be found by this
#' function.
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \value{
#' The relevant indices for interpolation.
#' }

findAgeIndicesCpp <- function(...) {
  return(findAgeIndicesCpp(...))
}

#' \name{calculateCentilesCpp}
#' \alias{calculateCentilesCpp}
#' \title{Calculation of centiles.}
#' \usage{calculateCentilesCpp(...)}
#' \description{Calculates the centiles for a vector of z-values.}
#' \details{
#' This function converts a vector of z-values to centiles based on the LMS method of Cole (1991).
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \value{`vector` of transformed values.}
#' \seealso{See also \code{\link{calculateCentileCpp}}, \code{\link{calculateZScoreCpp}}}
calculateCentilesCpp <- function(...) {
  return(calculateCentilesCpp(...))
}

#' \name{calculateCentileCpp}
#' \alias{calculateCentileCpp}
#' \title{Single centile calculation.}
#' \usage{calculateCentileCpp(...)}
#' \description{Calculate a single centile based on given LMS parameters.}
#' \details{
#' This function deterines the centile based on the given LMS parameters using
#' the LMS method of Cole (1991), which is commonly applied for growth curve analysis
#' based on the formula `centile = median * (1 + L * S * z)^(1 / L)`.
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \value{A single centile value.}
#' \seealso{See also \code{\link{calculateCentilesCpp}}, \code{\link{calculateZScoreCpp}}}
calculateCentileCpp <- function(...) {
  return(calculateCentileCpp(...))
}

#' \name{assignMedianBmiCpp}
#' \alias{assignMedianBmiCpp}
#' \title{Assign the median BMI to the children.}
#' \usage{assignMedianBmiCpp(...)}
#' \description{Assign the median BMI to the children.}
#' \details{
#' Assign the median BMI to the children.
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \value{`vector` of transformed values.}
#' \seealso{See also \code{\link{findAgeIndicesCpp}}}

assignMedianBmiCpp <- function(...) {
  return(assignMedianBmiCpp(...))
}

#' \name{interpolateCpp}
#' \alias{interpolateCpp}
#' \title{Linear interpolation between an upper and lower value.}
#' \usage{interpolateCpp(...)}
#' \description{Perform linear interpolation based on the lower / upper
#' reference age bound.}
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \details{
#' The basic functionality to perform linear interpolation using the proportion
#' of the upper and lower age bound,
#' relevant for the respective age of a child.
#' }
#' \value{A 'numeric' value, representing the linear interpolation.}
#' \seealso{See also \code{\link{getIndicesCpp}}, \code{\link{getProportionCpp}},
#' \code{\link{interpolateToZscoreCpp}}}

interpolateCpp <- function(...) {
  return(interpolateCpp(...))
}

#' \name{interpolateToZscoreCpp}
#' \alias{interpolateToZscoreCpp}
#' \title{Linear interpolation of LMS parameters.}
#' \usage{interpolateToZscoreCpp(...)}
#' \description{
#'  Interpolation of a vector of raw values of either weight, height or BMI to z-scores.
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \details{
#' For getting z-scores for values for ages, not covered by references tables,
#' linear transformation for ages in close proximity are used.
#' }
#' \value{
#' A 'vector' of z-score transforms.
#' }
#' \seealso{See also \code{\link{getIndicesCpp}}, \code{\link{getProportionCpp}}, \code{\link{interpolateCpp}}.}

interpolateToZscoreCpp <- function(...) {
  return(interpolateToZscoreCpp(...))
}

#' \name{getAgeCohortsCpp}
#' \alias{getAgeCohortsCpp}
#' \title{Assign age bounds to observations.}
#' \usage{getAgeCohortsCpp(...)}
#' \description{
#' Get the age bounds for each observation based on the age of the subject.
#' }
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \details{
#' For each observation the age is compared to the given age bounds, such that the given age range
#' is assigned to the respective observation, if the age at the time of measurement lies in the
#' given range. Note, that if the age cannot be assigned to any range, the assigned value is zero.
#' }
#' \value{
#' A list of with upper and lower age bounds.
#' }
#' \seealso{See also \code{\link{getIndicesCpp}}, \code{\link{getProportionCpp}}, \code{\link{interpolateCpp}}.}

getAgeCohortsCpp <- function(...) {
  return(getAgeCohortsCpp(...))
}

#' \name{getUniqueIdsCpp}
#' \alias{getUniqueIdsCpp}
#' \title{Retrieve unique IDs.}
#' \usage{getUniqueIdsCpp(...)}
#' \description{Return the unique IDs for a all observations.}
#' \arguments{
#'  \item{...}{Arguments.}
#' }
#' \details{
#' All unique subject IDs are extracted.
#' }
#' \value{
#' A `vector` of unique subject names.
#' }
#' \seealso{See also \code{\link{getIndicesCpp}}, \code{\link{getProportionCpp}}, \code{\link{interpolateCpp}}.}

getUniqueIdsCpp <- function(...) {
  return(getUniqueIdsCpp(...))
}

###  place startup loads here
.onLoad <- function(libname, pkgname) {
  # to show a startup message
  # example on how to initialize_data a Tcl package
  # tcltk::.Tcl(paste("lappend auto_path",file.path(system.file(package="Rpkg"),"pantcl", "lib")))
  # tcltk::.Tcl("package require tclfilters")
  # tools::vignetteEngine("pantcl",package=pkgname,weave=pantcl,tangle=ptangle)
  # Expose the interpolation module to R
  Rcpp::loadModule("interpolation_module", TRUE)
}
